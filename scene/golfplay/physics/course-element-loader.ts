/* Future parts
Windmill hole <-- neon
rotation cup <-- wooden
slicer <-- wooden
circular hitter
 */

import Bloque1x1x025 from "./models/Bloque1x1x025";
import Bloque1x2x1 from "./models/Bloque1x2x1";
import Bloque05x2x05 from "./models/Bloque05x2x05";
import Bloque05x05x025 from "./models/Bloque05x05x025";
import Bloque175x50x50 from "./models/Bloque175x50x50";//TODO its really 350(x)
import Corner1 from "./models/Corner1";
import Corner2 from "./models/Corner2";
import End1 from "./models/End1";
import End2 from "./models/End2";
import End3 from "./models/End3";
import End4 from "./models/End4";
import  End4_depth from "./models/End4_depth";
import End5 from "./models/End5";
import Part1 from "./models/Part1";
import Part2 from "./models/Part2";
import Part3 from "./models/Part3";
import Part4 from "./models/Part4";
import Part5 from "./models/Part5";
import Part6 from "./models/Part6";
import Part7 from "./models/Part7";
import Part8 from "./models/Part8";
import Part8_borderless from "./models/Part8_borderless";
import Cylinder1 from "./models/Cylinder1";
import Tabla from "./models/Tabla";
import Curve from "./models/Curve";
import CurveLowPloy from "./models/CurveLowPloy";
import Concave_Curve from "./models/Concave_Curve";
import Concave_Curve_center from "./models/Concave_Curve_center";
import Concave_Curve_corner from "./models/Concave_Curve_corner";
import Slope_Corner from "./models/Slope_Corner";
import Pra_cup_corner from "./models/Pra_cup_corner";
import Windmill from "./models/Windmill";
import End_Windmill from "./models/End_Windmill";
import Windmill_fan from "./models/Winndmill_fan";


import TreePine from "./models/TreePine";
import Base48 from "./models/Base48";
import House7 from "./models/House7";
import River from "./models/River";
import Bridge from "./models/Bridge";
import PetHouse from "./models/PetHouse";
import Ramp1 from "./models/Ramp1";
import Ramp2 from "./models/Ramp2";
import Ramp3 from "./models/Ramp3";
import Sand1 from "./models/Sand1";
import Skybox1 from "./models/Skybox1";
import Start1 from "./models/Start1";
import Wall1 from "./models/Wall1";
import Wind1 from "./models/Wind1";
import Dumper from "./models/Dumper";
import Dumper_square from "./models/Dumper_square";
import Dumper_rect from "./models/Dumper_rect";
import Dumper_box from "./models/Dumper_box";
import TreeHouse from "./models/TreeHouse";
import PlaygroundSlide_01 from "./models/PlaygroundSlide_01";
import PlaygroundHammock_01 from "./models/PlaygroundHammock_01";
import Corner_joint1 from "./models/Corner_joint1";
import part_rot1 from "./models/part_rot1";
import part_rot2 from "./models/part_rot2";
import Wall1_border from "./models/Wall1_border";

import Gutter from "./models/Gutter";
import GutterFunnel from "./models/GutterFunnel";
import PartBigCurve from "./models/PartBigCurve";
import PartBigCurveB from "./models/PartBigCurveB";
import PartCurves from "./models/PartCurves";
import PartTeeth from "./models/PartTeeth";
import PartWave from "./models/PartWave";
import PartWave2 from "./models/PartWave2";
import Part_thin from "./models/Part_thin";
import PartSlope from "./models/PartSlope";
import Part2_depthST from "./models/Part2_depthST";
import Part_pointyUP from "./models/Part_pointyUP";
import Part2_bend_edgless from "./models/Part2_bend_edgless";
import Part2_bend_wave from "./models/Part2_bend_wave";
import Tabla_grass from "./models/Tabla_grass";
import primitive_cube from "./models/primitive_cube";
import primitive_sphere from "./models/primitive_sphere";
import primitive_cone from "./models/primitive_cone";
import primitive_torus from "./models/primitive_torus";
import enneper_magnet from "./models/enneper_magnet";
import enclosed_cube from "./models/enclosed_cube";
import enclosed_sphere from "./models/enclosed_sphere";
import enclosed_cone from "./models/enclosed_cone";
import Gear_grass from "./models/Gear_grass";
import Gear_wood from "./models/Gear_wood";
import part_circlewood from "./models/part_circlewood";
import part_CircleWheeler from "./models/part_CircleWheeler";
import part_wood_support from "./models/part_wood_support";
import part_pendulum from "./models/part_pendulum";


import PartBigCurveLowPoly from "./models/PartBigCurveLowPoly";
import PartBigHalfCurveLowPoly from "./models/PartBigHalfCurveLowPoly";
import PartBigHalfCurveRamp from "./models/PartBigHalfCurveRamp";
import PartCurvesLowPoly from "./models/PartCurvesLowPoly";
import PartWoodInclined from "./models/PartWoodInclined";
import PartHalfCurveLowPoly from "./models/PartHalfCurveLowPoly";
import PartBig2Coaster from "./models/PartBig2Coaster"; 
import Partmid2Coaster from "./models/Partmid2Coaster";
import Base48_fantasy3 from "./models/Base48_fantasy3";
import Base48_fantasy1 from "./models/Base48_fantasy1";
import PartBigCurveB270 from "./models/PartBigCurveB270";
import PartBigCurveB360 from "./models/PartBigCurveB360";

import Partduo from "./models/Partduo";
import PartSlopeLowpoly from "./models/PartSlopeLowpoly";
import PartCircular_Cut from "./models/PartCircular_Cut";
import End_bump from "./models/End_bump";
import End_depth from "./models/End_depth";
import Part_centreBump from "./models/Part_centreBump";

import HouseChinese from "./models/HouseChinese";
import CircularSaw from "./models/CircularSaw";
import Fan from "./models/Fan";
import LandMine from "./models/LandMine";
import Ramp_small from "./models/Ramp_small";
import Tabla_stand from "./models/Tabla_stand";
import Part6_rot from "./models/Part6_rot";
import Part6_half from "./models/Part6_half";


//New series Part inclined bend
import Part2_bend from "./models/Part2_bend";
import Corner_dpath from "./models/Corner_dpath";
import Part2_dpath from "./models/Part2_dpath";
import Lift from "./models/Lift";
import Wall2 from "./models/Wall2";
import double_arrow from "./models/double_arrow";
import Navy_upward from "./models/Navy_upward";
import stairs from "./models/stairs";

//Halloween Parts
import HWN20_Center1 from "./models/HWN20_Center1";
import HWN20_Tree_02 from "./models/HWN20_Tree_02";
import HWN20_Tree_03 from "./models/HWN20_Tree_03";
import HWN20_Tree_06 from "./models/HWN20_Tree_06";
import HWN20_Tree_07 from "./models/HWN20_Tree_07";
import HWN20_Tree_08 from "./models/HWN20_Tree_08";
import HWN20_Tree_09 from "./models/HWN20_Tree_09";
import HWN20_TreeBase_Axe from "./models/HWN20_TreeBase_Axe";
import HWN20_TreeBase_Knife from "./models/HWN20_TreeBase_Knife";
import HWN20_TreeBase_01 from "./models/HWN20_TreeBase_01";
import HWN20_IronEntranceArch_01 from "./models/HWN20_IronEntranceArch_01";
import HWN20_IronEntranceArch_02 from "./models/HWN20_IronEntranceArch_02";
import HWN20_IronfFence_01 from "./models/HWN20_IronfFence_01";
import HWN20_IronfFence_02 from "./models/HWN20_IronfFence_02";
import HWN20_IronfFence_03 from "./models/HWN20_IronfFence_03";
import HWN20_IronfFence_04 from "./models/HWN20_IronfFence_04";
import HWN20_CoffinBase from "./models/HWN20_CoffinBase";
import HWN20_CoffinTop from "./models/HWN20_CoffinTop";
import HWN20_Grave_08 from "./models/HWN20_Grave_08";
import HWN20_Grave_09 from "./models/HWN20_Grave_09";
import HWN20_Grave_13 from "./models/HWN20_Grave_13";
import HWN20_Grave_14 from "./models/HWN20_Grave_14";
import HWN20_Grave_24 from "./models/HWN20_Grave_24";
import HWN20_PetTomb_01 from "./models/HWN20_PetTomb_01";
import HWN20_ScareCrow from "./models/HWN20_ScareCrow";
import HWN20_SkullChain_01 from "./models/HWN20_SkullChain_01";
import HWN20_SkullChain_02 from "./models/HWN20_SkullChain_02";
import HWN20_DragonBush from "./models/HWN20_DragonBush";
import HWN20_CrowTrio from "./models/HWN20_CrowTrio"
import PartSmall2Coaster from "./models/PartSmall2Coaster";
import PartSmall2Coaster_border from "./models/PartSmall2Coaster_border";
import Pyramid_hole_glb from "./models/Pyramid_hole_glb"
import Desert from "./models/Desert"
import Jungle from "./models/Jungle"
import smartSwitch from "./models/smart-switch";
import smartDoor from "./models/smart-door";
import Border from "./models/Border";
import Cube from  "./models/Cube";
import Floor from "./models/Floor" ;
import Obstacle from  "./models/Obstacle";
import small_border from  "./models/small_border";
import rectangle from  "./models/rectangle";
import Floor_corner from "./models/Floor_corner";
import Wall from "./models/Wall";
import Wall_border from "./models/Wall_border";
import Ramp from "./models/Ramp";
import Ramp_border from "./models/Ramp_border";
import egypt_skybox from "./models/egypt_skybox";
import space_skybox from "./models/space_skybox";
import urban_skybox from "./models/urban_skybox";
import jungle_skybox from "./models/jungle_skybox";
import mountain_skybox from "./models/mountain_skybox";
import cocobay_skybox from "./models/cocobay_skybox"; 
import demo_part from "./models/demo_part";



import {
    getMaterials
} from "./world";
import {USE_REMOTE_SERVER} from "../../../common/constants";

export const  cannonParts:any = {
    ["smart-door"]:smartDoor,
    ["smart-switch"]:smartSwitch,
    Bloque1x1x025,
    Bloque1x2x1,
    Bloque05x2x05,
    Bloque05x05x025,
    Bloque175x50x50,
    Corner1,
    Corner2,
    End1,
    End2,
    End3,
    End4,
    End4_depth,
    End5,
    Part1,
    Part2,
    Part2_bend_edgless,
    Part2_bend_wave,
    Part3,
    Part4,
    Part5,
    Part6,
    Part7,
    Part8,
    Cylinder1,
    Tabla,
    Tabla_stand,
    Curve,
    CurveLowPloy,
    Concave_Curve,
    Concave_Curve_center,
    Concave_Curve_corner,
    Pra_cup_corner,
    Corner_joint1,
    Slope_Corner,
    TreePine,
    Base48,
    House7,
    River,
    Bridge,
    PetHouse,
    Ramp1,
    Ramp2,
    Ramp3,
    Sand1,
    Skybox1,
    Start1,
    Wall1,
    Wall1_border,
    Wind1,
    Dumper,
    Dumper_square,
    Dumper_rect,
    Dumper_box,
    PartSlope,
    Fan,
    Ramp_small,
    CircularSaw,
    Gutter,
    GutterFunnel,
    PartBigCurve,
    PartBigCurveB,
    PartCurves,
    PartTeeth,
    PartWave,
    PartWave2,
    Partduo,
    Part_thin,
    Part2_depthST,
    Corner_dpath,
    Part2_dpath,
    Part6_rot,
    Part6_half,
    part_rot1,
    part_rot2,
    Part8_borderless,
    Tabla_grass,
    Lift,
    double_arrow,
    Navy_upward,
    stairs,
    Wall2,
    End_depth,
    End_bump,
    Part_centreBump,
    PartCircular_Cut,
    PartSlopeLowpoly,
    PartBigCurveLowPoly,
    PartBigHalfCurveLowPoly,
    PartBigHalfCurveRamp,
    PartCurvesLowPoly,
    PartWoodInclined,
    Part_pointyUP,
    PartHalfCurveLowPoly,
    PartBig2Coaster,
    PartSmall2Coaster,
    PartSmall2Coaster_border,
    Partmid2Coaster,
    PartBigCurveB270,
    PartBigCurveB360,
    HouseChinese,
    TreeHouse,
    LandMine,
    Windmill,
    Windmill_fan,
    End_Windmill,
    PlaygroundSlide_01,
    PlaygroundHammock_01,
    Base48_fantasy1,
    Base48_fantasy3,
    primitive_torus,
    primitive_cone,
    primitive_sphere,
    primitive_cube,
    enneper_magnet,
    Gear_grass,
    Gear_wood,
    enclosed_cone,
    enclosed_cube,
    enclosed_sphere,
    HWN20_Center1,
    HWN20_Tree_02,
    HWN20_Tree_03,
    HWN20_Tree_06,
    HWN20_Tree_07,
    HWN20_Tree_08,
    HWN20_Tree_09,
    HWN20_TreeBase_Axe,
    HWN20_TreeBase_Knife,
    HWN20_TreeBase_01,
    HWN20_IronEntranceArch_01,
    HWN20_IronEntranceArch_02,
    HWN20_IronfFence_01,
    HWN20_IronfFence_02,
    HWN20_IronfFence_03,
    HWN20_IronfFence_04,
    HWN20_CoffinBase,
    HWN20_CoffinTop,
    HWN20_Grave_08,
    HWN20_Grave_09,
    HWN20_Grave_13,
    HWN20_Grave_14,
    HWN20_Grave_24,
    HWN20_PetTomb_01,
    HWN20_ScareCrow,
    HWN20_SkullChain_01,
    HWN20_SkullChain_02,
    HWN20_DragonBush,
    Part2_bend,
    HWN20_CrowTrio,
    part_circlewood,
    part_CircleWheeler,
    part_wood_support,
    part_pendulum,
    Pyramid_hole_glb,
    Jungle,
    Desert,
    Border,
    Cube,
    Floor,
    Obstacle, //wood
    rectangle, // Dumper
    small_border,
    Floor_corner,
    Wall,
    Wall_border,
    Ramp,
    Ramp_border,
    egypt_skybox,
    space_skybox,
    urban_skybox,
    jungle_skybox,
    mountain_skybox,
    cocobay_skybox,
    demo_part
}
let lastTimeCalled = 0;
export const decorateRemotePhysicParts = async (fetch, wip?:boolean) => {
    try{
        if((lastTimeCalled+1000*60*5) > Date.now()) return;
        lastTimeCalled = Date.now();
        const partsURL = USE_REMOTE_SERVER ? `https://golfcraftgame.com/api/parts` : `http://localhost:2569/api/parts`;
        const remoteParts = await fetch(`${partsURL}${wip?`-wip`:``}`, {
            method:'POST',
            body:JSON.stringify({}),
            headers:{ "Content-Type":"application/json" }
        }).then(async r => await r.json());
        remoteParts.forEach((remotePart)=>{
            cannonParts[remotePart.alias] = JSON.parse(remotePart.definition);
        });
    }catch(err){
        console.log("error",err)
    }
}


type PartDefinition = {
    id:string,
    position:number[],
    rotation:number[],
    type:string,
    subtype:string,
    animation:any
};
const ignoreParts = ["control_area", "direction_area", "explosive_mine"];
const loadCoursePhysics = (world, {courseDefinition, overrideCannonParts}:any) => {
    const physicParts = courseDefinition.parts.map((partDefinition) => {
        return (
            partDefinition.type === "solid"
            && !~ignoreParts.indexOf(partDefinition.subtype))
            && partDefinition?.expressions?.runtime?.ignored !== "true"
            && partDefinition?.expressions?.runtime?.ignoredPhysics !== "true"
            && loadPartPhysics(world, {partDefinition, overrideCannonParts}); //TODO REVIEW: instead of checking id, maybe say "solid:true"?
    }).filter(p=>p);

    return physicParts.reduce((acc, part)=>{
        acc[part.id] = {
            definition:part.definition,
            bodies:part.bodies
        }
        return acc;
    },{})
}

const loadPartPhysics = (world, {partDefinition, overrideCannonParts}:{partDefinition:PartDefinition, overrideCannonParts:any}) => {
    const {id, position, subtype} = partDefinition;
    if(!(overrideCannonParts||cannonParts)[subtype]){
        console.log("missing part", subtype); 
        throw Error("Missing part "+subtype);
    }

    const bodies = (overrideCannonParts||cannonParts)[subtype].map( (section: any) => {
        const {material} = section;
        const shape = new CANNON.Trimesh(section.verts, section.faces);
        const [x,y,z] = position;
        const body = new CANNON.Body({
            mass: 0,
            shape,
            type:partDefinition.animation?CANNON.Body.KINEMATIC:undefined,
            position: new CANNON.Vec3(x,y,z),
        });
        body.collisionFilterGroup = 1;
        body.collisionFilterMask = 2;
        if(partDefinition.rotation){
            body.quaternion = new CANNON.Quaternion(...partDefinition.rotation);
        }
        const {grassPhysicsMaterial, woodPhysicsMaterial, dumperPhysicsMaterial} = getMaterials();
        const materials = {
            grass:grassPhysicsMaterial,
            wood:woodPhysicsMaterial,
            dumper:dumperPhysicsMaterial,
            default:grassPhysicsMaterial
        }

        body.material = materials[material] || materials.default;
        if(material === "wood"){
            body.angularDamping = 0.9;//TODO review if this has some effect, I was trying to avoid ball to go up after restitution with high impulse on corner-2walls
        }else if(material === "grass"){
            body.angularDamping = 0.1;
        }else if(material === "dumper"){
            body.angularDamping = 0.9;
        }

        world.addBody(body);
        return body;
    });

    return {
        id:partDefinition.id,
        bodies,
        definition:partDefinition
    };
}

export {
    loadCoursePhysics
};
