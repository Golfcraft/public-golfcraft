export default(function(t){var e={};function o(i){if(e[i])return e[i].exports;var n=e[i]={i,l:0,exports:{}};t[i].call(n.exports,n,n.exports,o);n.l=1;return n.exports}o.m=t;o.c=e;o.d=function(t,e,i){o.o(t,e)||Object.defineProperty(t,e,{enumerable:1,get:i})};o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"});Object.defineProperty(t,"__esModule",{value:1})};o.t=function(t,e){1&e&&(t=o(t));if(8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);o.r(i);Object.defineProperty(i,"default",{enumerable:1,value:t});if(2&e&&"string"!=typeof t)for(var n in t)o.d(i,n,function(e){return t[e]}.bind(null,n));return i};o.n=function(t){var e=t&&t.__esModule?function e(){return t["default"]}:function e(){return t};o.d(e,"a",e);return e};o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)};o.p="";return o(o.s=0)}([function(t,e,o){var i=this&&this.__createBinding||(Object.create?function(t,e,o,i){void 0===i&&(i=o);Object.defineProperty(t,i,{enumerable:1,get:function(){return e[o]}})}:function(t,e,o,i){void 0===i&&(i=o);t[i]=e[o]}),n=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:1,value:e})}:function(t,e){t["default"]=e}),s=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)"default"!==o&&Object.prototype.hasOwnProperty.call(t,o)&&i(e,t,o);n(e,t);return e};Object.defineProperty(e,"__esModule",{value:1});const r=s(o(1));e.default=r},function(t,e,o){var i,i;!function(e){1;t.exports=e();var o}((function(){var t,e,o;return function t(e,o,n){function s(a,l){if(!o[a]){if(!e[a]){var h;if(!l&&("function"==typeof i&&i))return i(a,1);if(r)return r(a,1);throw new Error("Cannot find module '"+a+"'")}var p=o[a]={exports:{}};e[a][0].call(p.exports,(function(t){var o=e[a][1][t];return s(o||t)}),p,p.exports,t,e,o,n)}return o[a].exports}for(var r="function"==typeof i&&i,a=0;a<n.length;a++)s(n[a]);return s}({1:[function(t,e,o){e.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,e,o){e.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(t,e,o){var i=t("../math/Vec3"),n=t("../utils/Utils");e.exports=s;function s(t){t=t||{};this.lowerBound=new i;t.lowerBound&&this.lowerBound.copy(t.lowerBound);this.upperBound=new i;t.upperBound&&this.upperBound.copy(t.upperBound)}var r=new i;s.prototype.setFromPoints=function(t,e,o,i){var n=this.lowerBound,s=this.upperBound,a=o;n.copy(t[0]);a&&a.vmult(n,n);s.copy(n);for(var l=1;l<t.length;l++){var h=t[l];if(a){a.vmult(h,r);h=r}h.x>s.x&&(s.x=h.x);h.x<n.x&&(n.x=h.x);h.y>s.y&&(s.y=h.y);h.y<n.y&&(n.y=h.y);h.z>s.z&&(s.z=h.z);h.z<n.z&&(n.z=h.z)}if(e){e.vadd(n,n);e.vadd(s,s)}if(i){n.x-=i;n.y-=i;n.z-=i;s.x+=i;s.y+=i;s.z+=i}return this};s.prototype.copy=function(t){this.lowerBound.copy(t.lowerBound);this.upperBound.copy(t.upperBound);return this};s.prototype.clone=function(){return(new s).copy(this)};s.prototype.extend=function(t){var e=t.lowerBound.x;this.lowerBound.x>e&&(this.lowerBound.x=e);var o=t.upperBound.x;this.upperBound.x<o&&(this.upperBound.x=o);var e=t.lowerBound.y;this.lowerBound.y>e&&(this.lowerBound.y=e);var o=t.upperBound.y;this.upperBound.y<o&&(this.upperBound.y=o);var e=t.lowerBound.z;this.lowerBound.z>e&&(this.lowerBound.z=e);var o=t.upperBound.z;this.upperBound.z<o&&(this.upperBound.z=o)};s.prototype.overlaps=function(t){var e=this.lowerBound,o=this.upperBound,i=t.lowerBound,n=t.upperBound;return(i.x<=o.x&&o.x<=n.x||e.x<=n.x&&n.x<=o.x)&&(i.y<=o.y&&o.y<=n.y||e.y<=n.y&&n.y<=o.y)&&(i.z<=o.z&&o.z<=n.z||e.z<=n.z&&n.z<=o.z)};s.prototype.contains=function(t){var e=this.lowerBound,o=this.upperBound,i=t.lowerBound,n=t.upperBound;return e.x<=i.x&&o.x>=n.x&&e.y<=i.y&&o.y>=n.y&&e.z<=i.z&&o.z>=n.z};s.prototype.getCorners=function(t,e,o,i,n,s,r,a){var l=this.lowerBound,h=this.upperBound;t.copy(l);e.set(h.x,l.y,l.z);o.set(h.x,h.y,l.z);i.set(l.x,h.y,h.z);n.set(h.x,l.y,l.z);s.set(l.x,h.y,l.z);r.set(l.x,l.y,h.z);a.copy(h)};var a=[new i,new i,new i,new i,new i,new i,new i,new i];s.prototype.toLocalFrame=function(t,e){var o=a,i=o[0],n=o[1],s=o[2],r=o[3],l=o[4],h=o[5],p=o[6],u=o[7];this.getCorners(i,n,s,r,l,h,p,u);for(var c=0;8!==c;c++){var d=o[c];t.pointToLocal(d,d)}return e.setFromPoints(o)};s.prototype.toWorldFrame=function(t,e){var o=a,i=o[0],n=o[1],s=o[2],r=o[3],l=o[4],h=o[5],p=o[6],u=o[7];this.getCorners(i,n,s,r,l,h,p,u);for(var c=0;8!==c;c++){var d=o[c];t.pointToWorld(d,d)}return e.setFromPoints(o)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(t,e,o){e.exports=i;function i(){this.matrix=[]}i.prototype.get=function(t,e){t=t.index;if((e=e.index)>t){var o=e;e=t;t=o}return this.matrix[(t*(t+1)>>1)+e-1]};i.prototype.set=function(t,e,o){t=t.index;if((e=e.index)>t){var i=e;e=t;t=i}this.matrix[(t*(t+1)>>1)+e-1]=o?1:0};i.prototype.reset=function(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0};i.prototype.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1}},{}],5:[function(t,e,o){var i=t("../objects/Body"),n=t("../math/Vec3"),s=t("../math/Quaternion"),r=t("../shapes/Shape"),a=t("../shapes/Plane");e.exports=l;function l(){this.world=null;this.useBoundingBoxes=0;this.dirty=1}l.prototype.collisionPairs=function(t,e,o){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var h=i.STATIC|i.KINEMATIC;l.prototype.needBroadphaseCollision=function(t,e){return 0==(t.collisionFilterGroup&e.collisionFilterMask)||0==(e.collisionFilterGroup&t.collisionFilterMask)?0:0==(t.type&h)&&t.sleepState!==i.SLEEPING||0==(e.type&h)&&e.sleepState!==i.SLEEPING?1:0};l.prototype.intersectionTest=function(t,e,o,i){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,o,i):this.doBoundingSphereBroadphase(t,e,o,i)};var p=new n,u=new n,c=new s,d=new n;l.prototype.doBoundingSphereBroadphase=function(t,e,o,i){var n=p;e.position.vsub(t.position,n);var s=Math.pow(t.boundingRadius+e.boundingRadius,2),r;if(n.norm2()<s){o.push(t);i.push(e)}};l.prototype.doBoundingBoxBroadphase=function(t,e,o,i){t.aabbNeedsUpdate&&t.computeAABB();e.aabbNeedsUpdate&&e.computeAABB();if(t.aabb.overlaps(e.aabb)){o.push(t);i.push(e)}};var v={keys:[]},f=[],y=[];l.prototype.makePairsUnique=function(t,e){for(var o=v,i=f,n=y,s=t.length,r=0;r!==s;r++){i[r]=t[r];n[r]=e[r]}t.length=0;e.length=0;for(var r=0;r!==s;r++){var a=i[r].id,l=n[r].id,h;o[h=a<l?a+","+l:l+","+a]=r;o.keys.push(h)}for(var r=0;r!==o.keys.length;r++){var h=o.keys.pop(),p=o[h];t.push(i[p]);e.push(n[p]);delete o[h]}};l.prototype.setWorld=function(t){};var m=new n;l.boundingSphereCheck=function(t,e){var o=m;t.position.vsub(e.position,o);return Math.pow(t.shape.boundingSphereRadius+e.shape.boundingSphereRadius,2)>o.norm2()};l.prototype.aabbQuery=function(t,e,o){void 0;return[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(t,e,o){e.exports=r;var i=t("./Broadphase"),n=t("../math/Vec3"),s=t("../shapes/Shape");function r(t,e,o,s,r){i.apply(this);this.nx=o||10;this.ny=s||10;this.nz=r||10;this.aabbMin=t||new n(100,100,100);this.aabbMax=e||new n(-100,-100,-100);var a=this.nx*this.ny*this.nz;if(a<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[];this.binLengths=[];this.bins.length=a;this.binLengths.length=a;for(var l=0;l<a;l++){this.bins[l]=[];this.binLengths[l]=0}}r.prototype=new i;r.prototype.constructor=r;var a=new n,l=new n;r.prototype.collisionPairs=function(t,e,o){for(var i=t.numObjects(),n=t.bodies,r=this.aabbMax,l=this.aabbMin,h=this.nx,p=this.ny,u=this.nz,c=p*u,d=u,v=1,f=r.x,y=r.y,m=r.z,w=l.x,x=l.y,g=l.z,b=h/(f-w),B=p/(y-x),E=u/(m-g),A=(f-w)/h,S=(y-x)/p,C=(m-g)/u,z=.5*Math.sqrt(A*A+S*S+C*C),q=s.types,M=q.SPHERE,R=q.PLANE,P=q.BOX,F=q.COMPOUND,V=q.CONVEXPOLYHEDRON,T=this.bins,I=this.binLengths,N=this.bins.length,W=0;W!==N;W++)I[W]=0;var L=Math.ceil,l=Math.min,r=Math.max;function j(t,e,o,i,n,s,r){var a=(t-w)*b|0,l=(e-x)*B|0,f=(o-g)*E|0,y=L((i-w)*b),m=L((n-x)*B),A=L((s-g)*E);a<0?a=0:a>=h&&(a=h-1);l<0?l=0:l>=p&&(l=p-1);f<0?f=0:f>=u&&(f=u-1);y<0?y=0:y>=h&&(y=h-1);m<0?m=0:m>=p&&(m=p-1);A<0?A=0:A>=u&&(A=u-1);l*=d;f*=v;y*=c;m*=d;A*=v;for(var S=a*=c;S<=y;S+=c)for(var C=l;C<=m;C+=d)for(var z=f;z<=A;z+=v){var q=S+C+z;T[q][I[q]++]=r}}for(var W=0;W!==i;W++){var O,_=(O=n[W]).shape;switch(_.type){case M:var k=O.position.x,U=O.position.y,H=O.position.z,D=_.radius;j(k-D,U-D,H-D,k+D,U+D,H+D,O);break;case R:_.worldNormalNeedsUpdate&&_.computeWorldNormal(O.quaternion);var X=_.worldNormal,G=w+.5*A-O.position.x,Y=x+.5*S-O.position.y,Q=g+.5*C-O.position.z,Z=a;Z.set(G,Y,Q);for(var K=0,J=0;K!==h;K++,J+=c,Z.y=Y,Z.x+=A)for(var $=0,tt=0;$!==p;$++,tt+=d,Z.z=Q,Z.y+=S)for(var et=0,ot=0;et!==u;et++,ot+=v,Z.z+=C)if(Z.dot(X)<z){var it=J+tt+ot;T[it][I[it]++]=O}break;default:O.aabbNeedsUpdate&&O.computeAABB();j(O.aabb.lowerBound.x,O.aabb.lowerBound.y,O.aabb.lowerBound.z,O.aabb.upperBound.x,O.aabb.upperBound.y,O.aabb.upperBound.z,O);break}}for(var W=0;W!==N;W++){var nt=I[W];if(nt>1)for(var st=T[W],K=0;K!==nt;K++)for(var O=st[K],$=0;$!==K;$++){var rt=st[$];this.needBroadphaseCollision(O,rt)&&this.intersectionTest(O,rt,e,o)}}this.makePairsUnique(e,o)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(t,e,o){e.exports=s;var i=t("./Broadphase"),n=t("./AABB");function s(){i.apply(this)}s.prototype=new i;s.prototype.constructor=s;s.prototype.collisionPairs=function(t,e,o){var i=t.bodies,n=i.length,s,r,a,l;for(s=0;s!==n;s++)for(r=0;r!==s;r++){a=i[s];l=i[r];this.needBroadphaseCollision(a,l)&&this.intersectionTest(a,l,e,o)}};var r=new n;s.prototype.aabbQuery=function(t,e,o){o=o||[];for(var i=0;i<t.bodies.length;i++){var n=t.bodies[i];n.aabbNeedsUpdate&&n.computeAABB();n.aabb.overlaps(e)&&o.push(n)}return o}},{"./AABB":3,"./Broadphase":5}],8:[function(t,e,o){e.exports=i;function i(){this.matrix={}}i.prototype.get=function(t,e){t=t.id;if((e=e.id)>t){var o=e;e=t;t=o}return t+"-"+e in this.matrix};i.prototype.set=function(t,e,o){t=t.id;if((e=e.id)>t){var i=e;e=t;t=i}o?this.matrix[t+"-"+e]=1:delete this.matrix[t+"-"+e]};i.prototype.reset=function(){this.matrix={}};i.prototype.setNumObjects=function(t){}},{}],9:[function(t,e,o){e.exports=u;var i=t("../math/Vec3"),n=t("../math/Quaternion"),s=t("../math/Transform"),r=t("../shapes/ConvexPolyhedron"),a=t("../shapes/Box"),l=t("../collision/RaycastResult"),h=t("../shapes/Shape"),p=t("../collision/AABB");function u(t,e){this.from=t?t.clone():new i;this.to=e?e.clone():new i;this._direction=new i;this.precision=1e-4;this.checkCollisionResponse=1;this.skipBackfaces=0;this.collisionFilterMask=-1;this.collisionFilterGroup=-1;this.mode=u.ANY;this.result=new l;this.hasHit=0;this.callback=function(t){}}u.prototype.constructor=u;u.CLOSEST=1;u.ANY=2;u.ALL=4;var c=new p,d=[];u.prototype.intersectWorld=function(t,e){this.mode=e.mode||u.ANY;this.result=e.result||new l;this.skipBackfaces=!!e.skipBackfaces;this.collisionFilterMask="undefined"!=typeof e.collisionFilterMask?e.collisionFilterMask:-1;this.collisionFilterGroup="undefined"!=typeof e.collisionFilterGroup?e.collisionFilterGroup:-1;e.from&&this.from.copy(e.from);e.to&&this.to.copy(e.to);this.callback=e.callback||function(){};this.hasHit=0;this.result.reset();this._updateDirection();this.getAABB(c);d.length=0;t.broadphase.aabbQuery(t,c,d);this.intersectBodies(d);return this.hasHit};var v=new i,f=new i;u.pointInTriangle=y;function y(t,e,o,i){i.vsub(e,U);o.vsub(e,v);t.vsub(e,f);var n=U.dot(U),s=U.dot(v),r=U.dot(f),a=v.dot(v),l=v.dot(f),h,p;return(h=a*r-s*l)>=0&&(p=n*l-s*r)>=0&&h+p<n*a-s*s}var m=new i,w=new n;u.prototype.intersectBody=function(t,e){if(e){this.result=e;this._updateDirection()}var o=this.checkCollisionResponse;if((!o||t.collisionResponse)&&0!=(this.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&this.collisionFilterMask))for(var i=m,n=w,s=0,r=t.shapes.length;s<r;s++){var a=t.shapes[s];if(!o||a.collisionResponse){t.quaternion.mult(t.shapeOrientations[s],n);t.quaternion.vmult(t.shapeOffsets[s],i);i.vadd(t.position,i);this.intersectShape(a,n,i,t);if(this.result._shouldStop)break}}};u.prototype.intersectBodies=function(t,e){if(e){this.result=e;this._updateDirection()}for(var o=0,i=t.length;!this.result._shouldStop&&o<i;o++)this.intersectBody(t[o])};u.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction);this._direction.normalize()};u.prototype.intersectShape=function(t,e,o,i){var n,s;if(!(D(this.from,this._direction,o)>t.boundingSphereRadius)){var r=this[t.type];r&&r.call(this,t,e,o,i)}};var x=new i,g=new i,b=new i,B=new i,E=new i,A=new i,S=new i,C=new l;u.prototype.intersectBox=function(t,e,o,i){return this.intersectConvex(t.convexPolyhedronRepresentation,e,o,i)};u.prototype[h.types.BOX]=u.prototype.intersectBox;u.prototype.intersectPlane=function(t,e,o,n){var s=this.from,r=this.to,a=this._direction,l=new i(0,0,1);e.vmult(l,l);var h=new i;s.vsub(o,h);var p=h.dot(l),u;r.vsub(o,h);if(!(p*h.dot(l)>0||s.distanceTo(r)<p)){var c=l.dot(a);if(!(Math.abs(c)<this.precision)){var d=new i,v=new i,f=new i;s.vsub(o,d);var y=-l.dot(d)/c;a.scale(y,v);s.vadd(v,f);this.reportIntersection(l,f,t,n,-1)}}};u.prototype[h.types.PLANE]=u.prototype.intersectPlane;u.prototype.getAABB=function(t){var e=this.to,o=this.from;t.lowerBound.x=Math.min(e.x,o.x);t.lowerBound.y=Math.min(e.y,o.y);t.lowerBound.z=Math.min(e.z,o.z);t.upperBound.x=Math.max(e.x,o.x);t.upperBound.y=Math.max(e.y,o.y);t.upperBound.z=Math.max(e.z,o.z)};var z={faceList:[0]};u.prototype.intersectHeightfield=function(t,e,o,n){var r=t.data,a=t.elementSize,l=new i,h=new u(this.from,this.to);s.pointToLocalFrame(o,e,h.from,h.from);s.pointToLocalFrame(o,e,h.to,h.to);var p=[],c=null,d=null,v=null,f=null,y=t.getIndexOfPosition(h.from.x,h.from.y,p,0);if(y){c=p[0];d=p[1];v=p[0];f=p[1]}if(y=t.getIndexOfPosition(h.to.x,h.to.y,p,0)){(null===c||p[0]<c)&&(c=p[0]);(null===v||p[0]>v)&&(v=p[0]);(null===d||p[1]<d)&&(d=p[1]);(null===f||p[1]>f)&&(f=p[1])}if(null!==c){var m=[];t.getRectMinMax(c,d,v,f,m);for(var w=m[0],x=m[1],g=c;g<=v;g++)for(var b=d;b<=f;b++){if(this.result._shouldStop)return;t.getConvexTrianglePillar(g,b,0);s.pointToWorldFrame(o,e,t.pillarOffset,l);this.intersectConvex(t.pillarConvex,e,l,n,z);if(this.result._shouldStop)return;t.getConvexTrianglePillar(g,b,1);s.pointToWorldFrame(o,e,t.pillarOffset,l);this.intersectConvex(t.pillarConvex,e,l,n,z)}}};u.prototype[h.types.HEIGHTFIELD]=u.prototype.intersectHeightfield;var q=new i,M=new i;u.prototype.intersectSphere=function(t,e,o,i){var n=this.from,s=this.to,r=t.radius,a=Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2)+Math.pow(s.z-n.z,2),l=2*((s.x-n.x)*(n.x-o.x)+(s.y-n.y)*(n.y-o.y)+(s.z-n.z)*(n.z-o.z)),h=Math.pow(n.x-o.x,2)+Math.pow(n.y-o.y,2)+Math.pow(n.z-o.z,2)-Math.pow(r,2),p=Math.pow(l,2)-4*a*h,u=q,c=M;if(!(p<0))if(0===p){n.lerp(s,p,u);u.vsub(o,c);c.normalize();this.reportIntersection(c,u,t,i,-1)}else{var d=(-l-Math.sqrt(p))/(2*a),v=(-l+Math.sqrt(p))/(2*a);if(d>=0&&d<=1){n.lerp(s,d,u);u.vsub(o,c);c.normalize();this.reportIntersection(c,u,t,i,-1)}if(this.result._shouldStop)return;if(v>=0&&v<=1){n.lerp(s,v,u);u.vsub(o,c);c.normalize();this.reportIntersection(c,u,t,i,-1)}}};u.prototype[h.types.SPHERE]=u.prototype.intersectSphere;var R=new i,P=new i,F=new i,V=new i;u.prototype.intersectConvex=function t(e,o,i,n,s){for(var r=P,a=R,l=V,h=F,p=s&&s.faceList||null,u=e.faces,c=e.vertices,d=e.faceNormals,v=this._direction,f=this.from,m=this.to,w=f.distanceTo(m),x=-1,g=p?p.length:u.length,S=this.result,C=0;!S._shouldStop&&C<g;C++){var z=p?p[C]:C,q=u[z],M=d[z],T=o,I=i;l.copy(c[q[0]]);T.vmult(l,l);l.vadd(I,l);l.vsub(f,l);T.vmult(M,a);var N=v.dot(a);if(!(Math.abs(N)<this.precision)){var W=a.dot(l)/N;if(!(W<0)){v.mult(W,b);b.vadd(f,b);B.copy(c[q[0]]);T.vmult(B,B);I.vadd(B,B);for(var L=1;!S._shouldStop&&L<q.length-1;L++){E.copy(c[q[L]]);A.copy(c[q[L+1]]);T.vmult(E,E);T.vmult(A,A);I.vadd(E,E);I.vadd(A,A);var j=b.distanceTo(f);!y(b,B,E,A)&&!y(b,E,B,A)||j>w||this.reportIntersection(a,b,e,n,z)}}}}};u.prototype[h.types.CONVEXPOLYHEDRON]=u.prototype.intersectConvex;var T=new i,I=new i,N=new i,W=new i,L=new i,j=new i,O=new p,_=[],k=new s;u.prototype.intersectTrimesh=function t(e,o,i,n,r){var a=T,l=_,h=k,p=P,u=V,c=F,d=O,v=I,f=N,m=W,w=j,x=L,g=r&&r.faceList||null,S=e.indices,C=e.vertices,z=e.faceNormals,q=this.from,M=this.to,R=this._direction,U=-1;h.position.copy(i);h.quaternion.copy(o);s.vectorToLocalFrame(i,o,R,v);s.pointToLocalFrame(i,o,q,f);s.pointToLocalFrame(i,o,M,m);var H=f.distanceSquared(m);e.tree.rayQuery(this,h,l);for(var D=0,X=l.length;!this.result._shouldStop&&D!==X;D++){var G=l[D];e.getNormal(G,a);e.getVertex(S[3*G],B);B.vsub(f,u);var Y=v.dot(a),Q=a.dot(u)/Y;if(!(Q<0)){v.scale(Q,b);b.vadd(f,b);e.getVertex(S[3*G+1],E);e.getVertex(S[3*G+2],A);var Z=b.distanceSquared(f);if(!(!y(b,E,B,A)&&!y(b,B,E,A)||Z>H)){s.vectorToWorldFrame(o,a,x);s.pointToWorldFrame(i,o,b,w);this.reportIntersection(x,w,e,n,G)}}}l.length=0};u.prototype[h.types.TRIMESH]=u.prototype.intersectTrimesh;u.prototype.reportIntersection=function(t,e,o,i,n){var s=this.from,r=this.to,a=s.distanceTo(e),l=this.result;if(!(this.skipBackfaces&&t.dot(this._direction)>0)){l.hitFaceIndex="undefined"!=typeof n?n:-1;switch(this.mode){case u.ALL:this.hasHit=1;l.set(s,r,t,e,o,i,a);l.hasHit=1;this.callback(l);break;case u.CLOSEST:if(a<l.distance||!l.hasHit){this.hasHit=1;l.hasHit=1;l.set(s,r,t,e,o,i,a)}break;case u.ANY:this.hasHit=1;l.hasHit=1;l.set(s,r,t,e,o,i,a);l._shouldStop=1;break}}};var U=new i,H=new i;function D(t,e,o){o.vsub(t,U);var i=U.dot(e),n;e.mult(i,H);H.vadd(t,H);return o.distanceTo(H)}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(t,e,o){var i=t("../math/Vec3");e.exports=n;function n(){this.rayFromWorld=new i;this.rayToWorld=new i;this.hitNormalWorld=new i;this.hitPointWorld=new i;this.hasHit=0;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=0}n.prototype.reset=function(){this.rayFromWorld.setZero();this.rayToWorld.setZero();this.hitNormalWorld.setZero();this.hitPointWorld.setZero();this.hasHit=0;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=0};n.prototype.abort=function(){this._shouldStop=1};n.prototype.set=function(t,e,o,i,n,s,r){this.rayFromWorld.copy(t);this.rayToWorld.copy(e);this.hitNormalWorld.copy(o);this.hitPointWorld.copy(i);this.shape=n;this.body=s;this.distance=r}},{"../math/Vec3":30}],11:[function(t,e,o){var i=t("../shapes/Shape"),n=t("../collision/Broadphase");e.exports=s;function s(t){n.apply(this);this.axisList=[];this.world=null;this.axisIndex=0;var e=this.axisList;this._addBodyHandler=function(t){e.push(t.body)};this._removeBodyHandler=function(t){var o=e.indexOf(t.body);-1!==o&&e.splice(o,1)};t&&this.setWorld(t)}s.prototype=new n;s.prototype.setWorld=function(t){this.axisList.length=0;for(var e=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler);t.removeEventListener("removeBody",this._removeBodyHandler);t.addEventListener("addBody",this._addBodyHandler);t.addEventListener("removeBody",this._removeBodyHandler);this.world=t;this.dirty=1};s.insertionSortX=function(t){for(var e=1,o=t.length;e<o;e++){for(var i=t[e],n=e-1;n>=0&&!(t[n].aabb.lowerBound.x<=i.aabb.lowerBound.x);n--)t[n+1]=t[n];t[n+1]=i}return t};s.insertionSortY=function(t){for(var e=1,o=t.length;e<o;e++){for(var i=t[e],n=e-1;n>=0&&!(t[n].aabb.lowerBound.y<=i.aabb.lowerBound.y);n--)t[n+1]=t[n];t[n+1]=i}return t};s.insertionSortZ=function(t){for(var e=1,o=t.length;e<o;e++){for(var i=t[e],n=e-1;n>=0&&!(t[n].aabb.lowerBound.z<=i.aabb.lowerBound.z);n--)t[n+1]=t[n];t[n+1]=i}return t};s.prototype.collisionPairs=function(t,e,o){var i=this.axisList,n=i.length,r=this.axisIndex,a,l;if(this.dirty){this.sortList();this.dirty=0}for(a=0;a!==n;a++){var h=i[a];for(l=a+1;l<n;l++){var p=i[l];if(this.needBroadphaseCollision(h,p)){if(!s.checkBounds(h,p,r))break;this.intersectionTest(h,p,e,o)}}}};s.prototype.sortList=function(){for(var t=this.axisList,e=this.axisIndex,o=t.length,i=0;i!==o;i++){var n=t[i];n.aabbNeedsUpdate&&n.computeAABB()}0===e?s.insertionSortX(t):1===e?s.insertionSortY(t):2===e&&s.insertionSortZ(t)};s.checkBounds=function(t,e,o){var i,n;if(0===o){i=t.position.x;n=e.position.x}else if(1===o){i=t.position.y;n=e.position.y}else if(2===o){i=t.position.z;n=e.position.z}var s=t.boundingRadius,r=e.boundingRadius,a=i-s,l,h,p=n+r;return n-r<i+s};s.prototype.autoDetectAxis=function(){for(var t=0,e=0,o=0,i=0,n=0,s=0,r=this.axisList,a=r.length,l=1/a,h=0;h!==a;h++){var p=r[h],u=p.position.x;t+=u;e+=u*u;var c=p.position.y;o+=c;i+=c*c;var d=p.position.z;n+=d;s+=d*d}var v=e-t*t*l,f=i-o*o*l,y=s-n*n*l;this.axisIndex=v>f?v>y?0:2:f>y?1:2};s.prototype.aabbQuery=function(t,e,o){o=o||[];if(this.dirty){this.sortList();this.dirty=0}var i=this.axisIndex,n="x";1===i&&(n="y");2===i&&(n="z");for(var s=this.axisList,r=e.lowerBound[n],a=e.upperBound[n],l=0;l<s.length;l++){var h=s[l];h.aabbNeedsUpdate&&h.computeAABB();h.aabb.overlaps(e)&&o.push(h)}return o}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(t,e,o){e.exports=h;var i=t("./Constraint"),n=t("./PointToPointConstraint"),s=t("../equations/ConeEquation"),r=t("../equations/RotationalEquation"),a=t("../equations/ContactEquation"),l=t("../math/Vec3");function h(t,e,o){var i="undefined"!=typeof(o=o||{}).maxForce?o.maxForce:1e6,a=o.pivotA?o.pivotA.clone():new l,h=o.pivotB?o.pivotB.clone():new l;this.axisA=o.axisA?o.axisA.clone():new l;this.axisB=o.axisB?o.axisB.clone():new l;n.call(this,t,a,e,h,i);this.collideConnected=!!o.collideConnected;this.angle="undefined"!=typeof o.angle?o.angle:0;var p=this.coneEquation=new s(t,e,o),u=this.twistEquation=new r(t,e,o);this.twistAngle="undefined"!=typeof o.twistAngle?o.twistAngle:0;p.maxForce=0;p.minForce=-i;u.maxForce=0;u.minForce=-i;this.equations.push(p,u)}h.prototype=new n;h.constructor=h;var p=new l,u=new l;h.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.coneEquation,i=this.twistEquation;n.prototype.update.call(this);t.vectorToWorldFrame(this.axisA,o.axisA);e.vectorToWorldFrame(this.axisB,o.axisB);this.axisA.tangents(i.axisA,i.axisA);t.vectorToWorldFrame(i.axisA,i.axisA);this.axisB.tangents(i.axisB,i.axisB);e.vectorToWorldFrame(i.axisB,i.axisB);o.angle=this.angle;i.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(t,e,o){e.exports=n;var i=t("../utils/Utils");function n(t,e,o){o=i.defaults(o,{collideConnected:1,wakeUpBodies:1});this.equations=[];this.bodyA=t;this.bodyB=e;this.id=n.idCounter++;this.collideConnected=o.collideConnected;if(o.wakeUpBodies){t&&t.wakeUp();e&&e.wakeUp()}}n.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")};n.prototype.enable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=1};n.prototype.disable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=0};n.idCounter=0},{"../utils/Utils":53}],14:[function(t,e,o){e.exports=s;var i=t("./Constraint"),n=t("../equations/ContactEquation");function s(t,e,o,s){i.call(this,t,e);"undefined"==typeof o&&(o=t.position.distanceTo(e.position));"undefined"==typeof s&&(s=1e6);this.distance=o;var r=this.distanceEquation=new n(t,e);this.equations.push(r);r.minForce=-s;r.maxForce=s}s.prototype=new i;s.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.distanceEquation,i=.5*this.distance,n=o.ni;e.position.vsub(t.position,n);n.normalize();n.mult(i,o.ri);n.mult(-i,o.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(t,e,o){e.exports=h;var i=t("./Constraint"),n=t("./PointToPointConstraint"),s=t("../equations/RotationalEquation"),r=t("../equations/RotationalMotorEquation"),a=t("../equations/ContactEquation"),l=t("../math/Vec3");function h(t,e,o){var i="undefined"!=typeof(o=o||{}).maxForce?o.maxForce:1e6,a=o.pivotA?o.pivotA.clone():new l,h=o.pivotB?o.pivotB.clone():new l,p,u;n.call(this,t,a,e,h,i);(this.axisA=o.axisA?o.axisA.clone():new l(1,0,0)).normalize();(this.axisB=o.axisB?o.axisB.clone():new l(1,0,0)).normalize();var c=this.rotationalEquation1=new s(t,e,o),d=this.rotationalEquation2=new s(t,e,o),v=this.motorEquation=new r(t,e,i);v.enabled=0;this.equations.push(c,d,v)}h.prototype=new n;h.constructor=h;h.prototype.enableMotor=function(){this.motorEquation.enabled=1};h.prototype.disableMotor=function(){this.motorEquation.enabled=0};h.prototype.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t};h.prototype.setMotorMaxForce=function(t){this.motorEquation.maxForce=t;this.motorEquation.minForce=-t};var p=new l,u=new l;h.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.motorEquation,i=this.rotationalEquation1,s=this.rotationalEquation2,r=p,a=u,l=this.axisA,h=this.axisB;n.prototype.update.call(this);t.quaternion.vmult(l,r);e.quaternion.vmult(h,a);r.tangents(i.axisA,s.axisA);i.axisB.copy(a);s.axisB.copy(a);if(this.motorEquation.enabled){t.quaternion.vmult(this.axisA,o.axisA);e.quaternion.vmult(this.axisB,o.axisB)}}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(t,e,o){e.exports=h;var i=t("./Constraint"),n=t("./PointToPointConstraint"),s=t("../equations/RotationalEquation"),r=t("../equations/RotationalMotorEquation"),a=t("../equations/ContactEquation"),l=t("../math/Vec3");function h(t,e,o){var i="undefined"!=typeof(o=o||{}).maxForce?o.maxForce:1e6,r=new l,a=new l,h=new l;t.position.vadd(e.position,h);h.scale(.5,h);e.pointToLocalFrame(h,a);t.pointToLocalFrame(h,r);n.call(this,t,r,e,a,i);var p=this.rotationalEquation1=new s(t,e,o),u=this.rotationalEquation2=new s(t,e,o),c=this.rotationalEquation3=new s(t,e,o);this.equations.push(p,u,c)}h.prototype=new n;h.constructor=h;var p=new l,u=new l;h.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.motorEquation,i=this.rotationalEquation1,s=this.rotationalEquation2,r=this.rotationalEquation3,a=p,h=u;n.prototype.update.call(this);t.vectorToWorldFrame(l.UNIT_X,i.axisA);e.vectorToWorldFrame(l.UNIT_Y,i.axisB);t.vectorToWorldFrame(l.UNIT_Y,s.axisA);e.vectorToWorldFrame(l.UNIT_Z,s.axisB);t.vectorToWorldFrame(l.UNIT_Z,r.axisA);e.vectorToWorldFrame(l.UNIT_X,r.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(t,e,o){e.exports=r;var i=t("./Constraint"),n=t("../equations/ContactEquation"),s=t("../math/Vec3");function r(t,e,o,r,a){i.call(this,t,o);a="undefined"!=typeof a?a:1e6;this.pivotA=e?e.clone():new s;this.pivotB=r?r.clone():new s;var l=this.equationX=new n(t,o),h=this.equationY=new n(t,o),p=this.equationZ=new n(t,o);this.equations.push(l,h,p);l.minForce=h.minForce=p.minForce=-a;l.maxForce=h.maxForce=p.maxForce=a;l.ni.set(1,0,0);h.ni.set(0,1,0);p.ni.set(0,0,1)}r.prototype=new i;r.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.equationX,i=this.equationY,n=this.equationZ;t.quaternion.vmult(this.pivotA,o.ri);e.quaternion.vmult(this.pivotB,o.rj);i.ri.copy(o.ri);i.rj.copy(o.rj);n.ri.copy(o.ri);n.rj.copy(o.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(t,e,o){e.exports=r;var i=t("../math/Vec3"),n=t("../math/Mat3"),s=t("./Equation");function r(t,e,o){var n="undefined"!=typeof(o=o||{}).maxForce?o.maxForce:1e6;s.call(this,t,e,-n,n);this.axisA=o.axisA?o.axisA.clone():new i(1,0,0);this.axisB=o.axisB?o.axisB.clone():new i(0,1,0);this.angle="undefined"!=typeof o.angle?o.angle:0}r.prototype=new s;r.prototype.constructor=r;var a=new i,l=new i;r.prototype.computeB=function(t){var e=this.a,o=this.b,i=this.axisA,n=this.axisB,s=a,r=l,h=this.jacobianElementA,p=this.jacobianElementB,u,c,d,v;i.cross(n,s);n.cross(i,r);h.rotational.copy(r);p.rotational.copy(s);return-(Math.cos(this.angle)-i.dot(n))*e-this.computeGW()*o-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(t,e,o){e.exports=r;var i=t("./Equation"),n=t("../math/Vec3"),s=t("../math/Mat3");function r(t,e,o){o="undefined"!=typeof o?o:1e6;i.call(this,t,e,0,o);this.restitution=0;this.ri=new n;this.rj=new n;this.ni=new n}r.prototype=new i;r.prototype.constructor=r;var a=new n,l=new n,h=new n;r.prototype.computeB=function(t){var e=this.a,o=this.b,i=this.bi,n=this.bj,s=this.ri,r=this.rj,p=a,u=l,c=i.velocity,d=i.angularVelocity,v=i.force,f=i.torque,y=n.velocity,m=n.angularVelocity,w=n.force,x=n.torque,g=h,b=this.jacobianElementA,B=this.jacobianElementB,E=this.ni;s.cross(E,p);r.cross(E,u);E.negate(b.spatial);p.negate(b.rotational);B.spatial.copy(E);B.rotational.copy(u);g.copy(n.position);g.vadd(r,g);g.vsub(i.position,g);g.vsub(s,g);var A=E.dot(g),S=this.restitution+1,C,z,q;return-A*e-(S*y.dot(E)-S*c.dot(E)+m.dot(u)-d.dot(p))*o-t*this.computeGiMf()};var p=new n,u=new n,c=new n,d=new n,v=new n;r.prototype.getImpactVelocityAlongNormal=function(){var t=p,e=u,o=c,i=d,n=v;this.bi.position.vadd(this.ri,o);this.bj.position.vadd(this.rj,i);this.bi.getVelocityAtWorldPoint(o,t);this.bj.getVelocityAtWorldPoint(i,e);t.vsub(e,n);return this.ni.dot(n)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(t,e,o){e.exports=s;var i=t("../math/JacobianElement"),n=t("../math/Vec3");function s(t,e,o,n){this.id=s.id++;this.minForce="undefined"==typeof o?-1e6:o;this.maxForce="undefined"==typeof n?1e6:n;this.bi=t;this.bj=e;this.a=0;this.b=0;this.eps=0;this.jacobianElementA=new i;this.jacobianElementB=new i;this.enabled=1;this.setSpookParams(1e7,4,1/60)}s.prototype.constructor=s;s.id=0;s.prototype.setSpookParams=function(t,e,o){var i=e,n=t,s=o;this.a=4/(s*(1+4*i));this.b=4*i/(1+4*i);this.eps=4/(s*s*n*(1+4*i))};s.prototype.computeB=function(t,e,o){var i=this.computeGW(),n,s;return-this.computeGq()*t-i*e-this.computeGiMf()*o};s.prototype.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.position,s=i.position;return t.spatial.dot(n)+e.spatial.dot(s)};var r=new n;s.prototype.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.velocity,s=i.velocity,a=o.angularVelocity||r,l=i.angularVelocity||r;return t.multiplyVectors(n,a)+e.multiplyVectors(s,l)};s.prototype.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.vlambda,s=i.vlambda,a=o.wlambda||r,l=i.wlambda||r;return t.multiplyVectors(n,a)+e.multiplyVectors(s,l)};var a=new n,l=new n,h=new n,p=new n;s.prototype.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.force,s=o.torque,r=i.force,u=i.torque,c=o.invMassSolve,d=i.invMassSolve;o.invInertiaWorldSolve?o.invInertiaWorldSolve.vmult(s,h):h.set(0,0,0);i.invInertiaWorldSolve?i.invInertiaWorldSolve.vmult(u,p):p.set(0,0,0);n.mult(c,a);r.mult(d,l);return t.multiplyVectors(a,h)+e.multiplyVectors(l,p)};var u=new n;s.prototype.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.invMassSolve,s=i.invMassSolve,r=o.invInertiaWorldSolve,a=i.invInertiaWorldSolve,l=n+s;if(r){r.vmult(t.rotational,u);l+=u.dot(t.rotational)}if(a){a.vmult(e.rotational,u);l+=u.dot(e.rotational)}return l};var c=new n,d=new n,v=new n,f=new n,y=new n,m=new n;s.prototype.addToWlambda=function(t){var e=this.jacobianElementA,o=this.jacobianElementB,i=this.bi,n=this.bj,s=c;e.spatial.mult(i.invMassSolve*t,s);i.vlambda.vadd(s,i.vlambda);o.spatial.mult(n.invMassSolve*t,s);n.vlambda.vadd(s,n.vlambda);if(i.invInertiaWorldSolve){i.invInertiaWorldSolve.vmult(e.rotational,s);s.mult(t,s);i.wlambda.vadd(s,i.wlambda)}if(n.invInertiaWorldSolve){n.invInertiaWorldSolve.vmult(o.rotational,s);s.mult(t,s);n.wlambda.vadd(s,n.wlambda)}};s.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(t,e,o){e.exports=r;var i=t("./Equation"),n=t("../math/Vec3"),s=t("../math/Mat3");function r(t,e,o){i.call(this,t,e,-o,o);this.ri=new n;this.rj=new n;this.t=new n}r.prototype=new i;r.prototype.constructor=r;var a=new n,l=new n;r.prototype.computeB=function(t){var e=this.a,o=this.b,i=this.bi,n=this.bj,s=this.ri,r=this.rj,h=a,p=l,u=this.t;s.cross(u,h);r.cross(u,p);var c=this.jacobianElementA,d=this.jacobianElementB,v,f,y;u.negate(c.spatial);h.negate(c.rotational);d.spatial.copy(u);d.rotational.copy(p);return-this.computeGW()*o-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(t,e,o){e.exports=r;var i=t("../math/Vec3"),n=t("../math/Mat3"),s=t("./Equation");function r(t,e,o){var n="undefined"!=typeof(o=o||{}).maxForce?o.maxForce:1e6;s.call(this,t,e,-n,n);this.axisA=o.axisA?o.axisA.clone():new i(1,0,0);this.axisB=o.axisB?o.axisB.clone():new i(0,1,0);this.maxAngle=Math.PI/2}r.prototype=new s;r.prototype.constructor=r;var a=new i,l=new i;r.prototype.computeB=function(t){var e=this.a,o=this.b,i=this.axisA,n=this.axisB,s=a,r=l,h=this.jacobianElementA,p=this.jacobianElementB,u,c,d,v;i.cross(n,s);n.cross(i,r);h.rotational.copy(r);p.rotational.copy(s);return-(Math.cos(this.maxAngle)-i.dot(n))*e-this.computeGW()*o-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(t,e,o){e.exports=r;var i=t("../math/Vec3"),n=t("../math/Mat3"),s=t("./Equation");function r(t,e,o){o="undefined"!=typeof o?o:1e6;s.call(this,t,e,-o,o);this.axisA=new i;this.axisB=new i;this.targetVelocity=0}r.prototype=new s;r.prototype.constructor=r;r.prototype.computeB=function(t){var e=this.a,o=this.b,i=this.bi,n=this.bj,s=this.axisA,r=this.axisB,a=this.jacobianElementA,l=this.jacobianElementB,h,p,u;a.rotational.copy(s);r.negate(l.rotational);return-(this.computeGW()-this.targetVelocity)*o-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(t,e,o){var i=t("../utils/Utils");e.exports=n;function n(t,e,o){o=i.defaults(o,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3});this.id=n.idCounter++;this.materials=[t,e];this.friction=o.friction;this.restitution=o.restitution;this.contactEquationStiffness=o.contactEquationStiffness;this.contactEquationRelaxation=o.contactEquationRelaxation;this.frictionEquationStiffness=o.frictionEquationStiffness;this.frictionEquationRelaxation=o.frictionEquationRelaxation}n.idCounter=0},{"../utils/Utils":53}],25:[function(t,e,o){e.exports=i;function i(t){var e="";if("string"==typeof(t=t||{})){e=t;t={}}else"object"==typeof t&&(e="");this.name=e;this.id=i.idCounter++;this.friction="undefined"!=typeof t.friction?t.friction:-1;this.restitution="undefined"!=typeof t.restitution?t.restitution:-1}i.idCounter=0},{}],26:[function(t,e,o){e.exports=n;var i=t("./Vec3");function n(){this.spatial=new i;this.rotational=new i}n.prototype.multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)};n.prototype.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)}},{"./Vec3":30}],27:[function(t,e,o){e.exports=n;var i=t("./Vec3");function n(t){this.elements=t||[0,0,0,0,0,0,0,0,0]}n.prototype.identity=function(){var t=this.elements;t[0]=1;t[1]=0;t[2]=0;t[3]=0;t[4]=1;t[5]=0;t[6]=0;t[7]=0;t[8]=1};n.prototype.setZero=function(){var t=this.elements;t[0]=0;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=0;t[6]=0;t[7]=0;t[8]=0};n.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x;e[4]=t.y;e[8]=t.z};n.prototype.getTrace=function(t){var t=t||new i,e=this.elements;t.x=e[0];t.y=e[4];t.z=e[8]};n.prototype.vmult=function(t,e){e=e||new i;var o=this.elements,n=t.x,s=t.y,r=t.z;e.x=o[0]*n+o[1]*s+o[2]*r;e.y=o[3]*n+o[4]*s+o[5]*r;e.z=o[6]*n+o[7]*s+o[8]*r;return e};n.prototype.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t};n.prototype.mmult=function(t,e){for(var o=e||new n,i=0;i<3;i++)for(var s=0;s<3;s++){for(var r=0,a=0;a<3;a++)r+=t.elements[i+3*a]*this.elements[a+3*s];o.elements[i+3*s]=r}return o};n.prototype.scale=function(t,e){e=e||new n;for(var o=this.elements,i=e.elements,s=0;3!==s;s++){i[3*s+0]=t.x*o[3*s+0];i[3*s+1]=t.y*o[3*s+1];i[3*s+2]=t.z*o[3*s+2]}return e};n.prototype.solve=function(t,e){e=e||new i;for(var o=3,n=4,s=[],r=0,r,a;r<o*n;r++)s.push(0);for(r=0;r<3;r++)for(a=0;a<3;a++)s[r+n*a]=this.elements[r+3*a];s[3]=t.x;s[7]=t.y;s[11]=t.z;var l=3,h=l,p,u=4,c,d;do{if(0===s[(r=h-l)+n*r])for(a=r+1;a<h;a++)if(0!==s[r+n*a]){p=u;do{s[(c=u-p)+n*r]+=s[c+n*a]}while(--p);break}if(0!==s[r+n*r])for(a=r+1;a<h;a++){var v=s[r+n*a]/s[r+n*r];p=u;do{s[(c=u-p)+n*a]=c<=r?0:s[c+n*a]-s[c+n*r]*v}while(--p)}}while(--l);e.z=s[2*n+3]/s[2*n+2];e.y=(s[1*n+3]-s[1*n+2]*e.z)/s[1*n+1];e.x=(s[0*n+3]-s[0*n+2]*e.z-s[0*n+1]*e.y)/s[0*n+0];if(isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||e.x===1/0||e.y===1/0||e.z===1/0)throw"Could not solve equation! Got x=["+e.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return e};n.prototype.e=function(t,e,o){if(void 0===o)return this.elements[e+3*t];this.elements[e+3*t]=o};n.prototype.copy=function(t){for(var e=0;e<t.elements.length;e++)this.elements[e]=t.elements[e];return this};n.prototype.toString=function(){for(var t="",e=",",o=0;o<9;o++)t+=this.elements[o]+e;return t};n.prototype.reverse=function(t){t=t||new n;for(var e=3,o=6,i=[],s=0,s,r;s<e*o;s++)i.push(0);for(s=0;s<3;s++)for(r=0;r<3;r++)i[s+o*r]=this.elements[s+3*r];i[3]=1;i[9]=0;i[15]=0;i[4]=0;i[10]=1;i[16]=0;i[5]=0;i[11]=0;i[17]=1;var a=3,l=a,h,p=o,u;do{if(0===i[(s=l-a)+o*s])for(r=s+1;r<l;r++)if(0!==i[s+o*r]){h=p;do{i[(u=p-h)+o*s]+=i[u+o*r]}while(--h);break}if(0!==i[s+o*s])for(r=s+1;r<l;r++){var c=i[s+o*r]/i[s+o*s];h=p;do{i[(u=p-h)+o*r]=u<=s?0:i[u+o*r]-i[u+o*s]*c}while(--h)}}while(--a);s=2;do{r=s-1;do{var c=i[s+o*r]/i[s+o*s];h=o;do{i[(u=o-h)+o*r]=i[u+o*r]-i[u+o*s]*c}while(--h)}while(r--)}while(--s);s=2;do{var c=1/i[s+o*s];h=o;do{i[(u=o-h)+o*s]=i[u+o*s]*c}while(--h)}while(s--);s=2;do{r=2;do{u=i[e+r+o*s];if(isNaN(u)||u===1/0)throw"Could not reverse! A=["+this.toString()+"]";t.e(s,r,u)}while(r--)}while(s--);return t};n.prototype.setRotationFromQuaternion=function(t){var e=t.x,o=t.y,i=t.z,n=t.w,s=e+e,r=o+o,a=i+i,l=e*s,h=e*r,p=e*a,u=o*r,c=o*a,d=i*a,v=n*s,f=n*r,y=n*a,m=this.elements;m[0]=1-(u+d);m[1]=h-y;m[2]=p+f;m[3]=h+y;m[4]=1-(l+d);m[5]=c-v;m[6]=p-f;m[7]=c+v;m[8]=1-(l+u);return this};n.prototype.transpose=function(t){for(var e=(t=t||new n).elements,o=this.elements,i=0;3!==i;i++)for(var s=0;3!==s;s++)e[3*i+s]=o[3*s+i];return t}},{"./Vec3":30}],28:[function(t,e,o){e.exports=n;var i=t("./Vec3");function n(t,e,o,i){this.x=void 0!==t?t:0;this.y=void 0!==e?e:0;this.z=void 0!==o?o:0;this.w=void 0!==i?i:1}n.prototype.set=function(t,e,o,i){this.x=t;this.y=e;this.z=o;this.w=i};n.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w};n.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]};n.prototype.setFromAxisAngle=function(t,e){var o=Math.sin(.5*e);this.x=t.x*o;this.y=t.y*o;this.z=t.z*o;this.w=Math.cos(.5*e)};n.prototype.toAxisAngle=function(t){t=t||new i;this.normalize();var e=2*Math.acos(this.w),o=Math.sqrt(1-this.w*this.w);if(o<.001){t.x=this.x;t.y=this.y;t.z=this.z}else{t.x=this.x/o;t.y=this.y/o;t.z=this.z/o}return[t,e]};var s=new i,r=new i;n.prototype.setFromVectors=function(t,e){if(t.isAntiparallelTo(e)){var o=s,i=r;t.tangents(o,i);this.setFromAxisAngle(o,Math.PI)}else{var n=t.cross(e);this.x=n.x;this.y=n.y;this.z=n.z;this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e);this.normalize()}};var a=new i,l=new i,h=new i;n.prototype.mult=function(t,e){e=e||new n;var o=this.w,i=a,s=l,r=h;i.set(this.x,this.y,this.z);s.set(t.x,t.y,t.z);e.w=o*t.w-i.dot(s);i.cross(s,r);e.x=o*s.x+t.w*i.x+r.x;e.y=o*s.y+t.w*i.y+r.y;e.z=o*s.z+t.w*i.z+r.z;return e};n.prototype.inverse=function(t){var e=this.x,o=this.y,i=this.z,s=this.w;t=t||new n;this.conjugate(t);var r=1/(e*e+o*o+i*i+s*s);t.x*=r;t.y*=r;t.z*=r;t.w*=r;return t};n.prototype.conjugate=function(t){(t=t||new n).x=-this.x;t.y=-this.y;t.z=-this.z;t.w=this.w;return t};n.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);if(0===t){this.x=0;this.y=0;this.z=0;this.w=0}else{t=1/t;this.x*=t;this.y*=t;this.z*=t;this.w*=t}};n.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;if(0===t){this.x=0;this.y=0;this.z=0;this.w=0}else{this.x*=t;this.y*=t;this.z*=t;this.w*=t}};n.prototype.vmult=function(t,e){e=e||new i;var o=t.x,n=t.y,s=t.z,r=this.x,a=this.y,l=this.z,h=this.w,p=h*o+a*s-l*n,u=h*n+l*o-r*s,c=h*s+r*n-a*o,d=-r*o-a*n-l*s;e.x=p*h+d*-r+u*-l-c*-a;e.y=u*h+d*-a+c*-r-p*-l;e.z=c*h+d*-l+p*-a-u*-r;return e};n.prototype.copy=function(t){this.x=t.x;this.y=t.y;this.z=t.z;this.w=t.w;return this};n.prototype.toEuler=function(t,e){e=e||"YZX";var o,i,n,s=this.x,r=this.y,a=this.z,l=this.w;switch(e){case"YZX":var h=s*r+a*l;if(h>.499){o=2*Math.atan2(s,l);i=Math.PI/2;n=0}if(h<-.499){o=-2*Math.atan2(s,l);i=-Math.PI/2;n=0}if(isNaN(o)){var p=s*s,u=r*r,c=a*a;o=Math.atan2(2*r*l-2*s*a,1-2*u-2*c);i=Math.asin(2*h);n=Math.atan2(2*s*l-2*r*a,1-2*p-2*c)}break;default:throw new Error("Euler order "+e+" not supported yet.")}t.y=o;t.z=i;t.x=n};n.prototype.setFromEuler=function(t,e,o,i){i=i||"XYZ";var n=Math.cos(t/2),s=Math.cos(e/2),r=Math.cos(o/2),a=Math.sin(t/2),l=Math.sin(e/2),h=Math.sin(o/2);if("XYZ"===i){this.x=a*s*r+n*l*h;this.y=n*l*r-a*s*h;this.z=n*s*h+a*l*r;this.w=n*s*r-a*l*h}else if("YXZ"===i){this.x=a*s*r+n*l*h;this.y=n*l*r-a*s*h;this.z=n*s*h-a*l*r;this.w=n*s*r+a*l*h}else if("ZXY"===i){this.x=a*s*r-n*l*h;this.y=n*l*r+a*s*h;this.z=n*s*h+a*l*r;this.w=n*s*r-a*l*h}else if("ZYX"===i){this.x=a*s*r-n*l*h;this.y=n*l*r+a*s*h;this.z=n*s*h-a*l*r;this.w=n*s*r+a*l*h}else if("YZX"===i){this.x=a*s*r+n*l*h;this.y=n*l*r+a*s*h;this.z=n*s*h-a*l*r;this.w=n*s*r-a*l*h}else if("XZY"===i){this.x=a*s*r-n*l*h;this.y=n*l*r-a*s*h;this.z=n*s*h+a*l*r;this.w=n*s*r+a*l*h}return this};n.prototype.clone=function(){return new n(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(t,e,o){var i=t("./Vec3"),n=t("./Quaternion");e.exports=s;function s(t){t=t||{};this.position=new i;t.position&&this.position.copy(t.position);this.quaternion=new n;t.quaternion&&this.quaternion.copy(t.quaternion)}var r=new n;s.pointToLocalFrame=function(t,e,o,n){var n=n||new i;o.vsub(t,n);e.conjugate(r);r.vmult(n,n);return n};s.prototype.pointToLocal=function(t,e){return s.pointToLocalFrame(this.position,this.quaternion,t,e)};s.pointToWorldFrame=function(t,e,o,n){var n=n||new i;e.vmult(o,n);n.vadd(t,n);return n};s.prototype.pointToWorld=function(t,e){return s.pointToWorldFrame(this.position,this.quaternion,t,e)};s.prototype.vectorToWorldFrame=function(t,e){var e=e||new i;this.quaternion.vmult(t,e);return e};s.vectorToWorldFrame=function(t,e,o){t.vmult(e,o);return o};s.vectorToLocalFrame=function(t,e,o,n){var n=n||new i;e.w*=-1;e.vmult(o,n);e.w*=-1;return n}},{"./Quaternion":28,"./Vec3":30}],30:[function(t,e,o){e.exports=n;var i=t("./Mat3");function n(t,e,o){this.x=t||0;this.y=e||0;this.z=o||0}n.ZERO=new n(0,0,0);n.UNIT_X=new n(1,0,0);n.UNIT_Y=new n(0,1,0);n.UNIT_Z=new n(0,0,1);n.prototype.cross=function(t,e){var o=t.x,i=t.y,s=t.z,r=this.x,a=this.y,l=this.z;(e=e||new n).x=a*s-l*i;e.y=l*o-r*s;e.z=r*i-a*o;return e};n.prototype.set=function(t,e,o){this.x=t;this.y=e;this.z=o;return this};n.prototype.setZero=function(){this.x=this.y=this.z=0};n.prototype.vadd=function(t,e){if(!e)return new n(this.x+t.x,this.y+t.y,this.z+t.z);e.x=t.x+this.x;e.y=t.y+this.y;e.z=t.z+this.z};n.prototype.vsub=function(t,e){if(!e)return new n(this.x-t.x,this.y-t.y,this.z-t.z);e.x=this.x-t.x;e.y=this.y-t.y;e.z=this.z-t.z};n.prototype.crossmat=function(){return new i([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])};n.prototype.normalize=function(){var t=this.x,e=this.y,o=this.z,i=Math.sqrt(t*t+e*e+o*o);if(i>0){var n=1/i;this.x*=n;this.y*=n;this.z*=n}else{this.x=0;this.y=0;this.z=0}return i};n.prototype.unit=function(t){t=t||new n;var e=this.x,o=this.y,i=this.z,s=Math.sqrt(e*e+o*o+i*i);if(s>0){s=1/s;t.x=e*s;t.y=o*s;t.z=i*s}else{t.x=1;t.y=0;t.z=0}return t};n.prototype.norm=function(){var t=this.x,e=this.y,o=this.z;return Math.sqrt(t*t+e*e+o*o)};n.prototype.length=n.prototype.norm;n.prototype.norm2=function(){return this.dot(this)};n.prototype.lengthSquared=n.prototype.norm2;n.prototype.distanceTo=function(t){var e=this.x,o=this.y,i=this.z,n=t.x,s=t.y,r=t.z;return Math.sqrt((n-e)*(n-e)+(s-o)*(s-o)+(r-i)*(r-i))};n.prototype.distanceSquared=function(t){var e=this.x,o=this.y,i=this.z,n=t.x,s=t.y,r=t.z;return(n-e)*(n-e)+(s-o)*(s-o)+(r-i)*(r-i)};n.prototype.mult=function(t,e){e=e||new n;var o=this.x,i=this.y,s=this.z;e.x=t*o;e.y=t*i;e.z=t*s;return e};n.prototype.scale=n.prototype.mult;n.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z};n.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z};n.prototype.negate=function(t){(t=t||new n).x=-this.x;t.y=-this.y;t.z=-this.z;return t};var s=new n,r=new n;n.prototype.tangents=function(t,e){var o=this.norm();if(o>0){var i=s,n=1/o;i.set(this.x*n,this.y*n,this.z*n);var a=r;if(Math.abs(i.x)<.9){a.set(1,0,0);i.cross(a,t)}else{a.set(0,1,0);i.cross(a,t)}i.cross(t,e)}else{t.set(1,0,0);e.set(0,1,0)}};n.prototype.toString=function(){return this.x+","+this.y+","+this.z};n.prototype.toArray=function(){return[this.x,this.y,this.z]};n.prototype.copy=function(t){this.x=t.x;this.y=t.y;this.z=t.z;return this};n.prototype.lerp=function(t,e,o){var i=this.x,n=this.y,s=this.z;o.x=i+(t.x-i)*e;o.y=n+(t.y-n)*e;o.z=s+(t.z-s)*e};n.prototype.almostEquals=function(t,e){void 0===e&&(e=1e-6);return Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e?0:1};n.prototype.almostZero=function(t){void 0===t&&(t=1e-6);return Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t?0:1};var a=new n;n.prototype.isAntiparallelTo=function(t,e){this.negate(a);return a.almostEquals(t,e)};n.prototype.clone=function(){return new n(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(t,e,o){e.exports=u;var i=t("../utils/EventTarget"),n=t("../shapes/Shape"),s=t("../math/Vec3"),r=t("../math/Mat3"),a=t("../math/Quaternion"),l=t("../material/Material"),h=t("../collision/AABB"),p=t("../shapes/Box");function u(t){t=t||{};i.apply(this);this.id=u.idCounter++;this.world=null;this.preStep=null;this.postStep=null;this.vlambda=new s;this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1;this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:1;this.collisionResponse=1;this.position=new s;t.position&&this.position.copy(t.position);this.previousPosition=new s;this.initPosition=new s;this.velocity=new s;t.velocity&&this.velocity.copy(t.velocity);this.initVelocity=new s;this.force=new s;var e="number"==typeof t.mass?t.mass:0;this.mass=e;this.invMass=e>0?1/e:0;this.material=t.material||null;this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01;this.type=e<=0?u.STATIC:u.DYNAMIC;typeof t.type==typeof u.STATIC&&(this.type=t.type);this.allowSleep="undefined"!=typeof t.allowSleep?t.allowSleep:1;this.sleepState=0;this.sleepSpeedLimit="undefined"!=typeof t.sleepSpeedLimit?t.sleepSpeedLimit:.1;this.sleepTimeLimit="undefined"!=typeof t.sleepTimeLimit?t.sleepTimeLimit:1;this.timeLastSleepy=0;this._wakeUpAfterNarrowphase=0;this.torque=new s;this.quaternion=new a;t.quaternion&&this.quaternion.copy(t.quaternion);this.initQuaternion=new a;this.angularVelocity=new s;t.angularVelocity&&this.angularVelocity.copy(t.angularVelocity);this.initAngularVelocity=new s;this.interpolatedPosition=new s;this.interpolatedQuaternion=new a;this.shapes=[];this.shapeOffsets=[];this.shapeOrientations=[];this.inertia=new s;this.invInertia=new s;this.invInertiaWorld=new r;this.invMassSolve=0;this.invInertiaSolve=new s;this.invInertiaWorldSolve=new r;this.fixedRotation="undefined"!=typeof t.fixedRotation?t.fixedRotation:0;this.angularDamping="undefined"!=typeof t.angularDamping?t.angularDamping:.01;this.aabb=new h;this.aabbNeedsUpdate=1;this.wlambda=new s;t.shape&&this.addShape(t.shape);this.updateMassProperties()}u.prototype=new i;u.prototype.constructor=u;u.DYNAMIC=1;u.STATIC=2;u.KINEMATIC=4;u.AWAKE=0;u.SLEEPY=1;u.SLEEPING=2;u.idCounter=0;u.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0;t===u.SLEEPING&&this.dispatchEvent({type:"wakeup"})};u.prototype.sleep=function(){this.sleepState=u.SLEEPING;this.velocity.set(0,0,0);this.angularVelocity.set(0,0,0)};u.sleepyEvent={type:"sleepy"};u.sleepEvent={type:"sleep"};u.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,o=this.velocity.norm2()+this.angularVelocity.norm2(),i=Math.pow(this.sleepSpeedLimit,2);if(e===u.AWAKE&&o<i){this.sleepState=u.SLEEPY;this.timeLastSleepy=t;this.dispatchEvent(u.sleepyEvent)}else if(e===u.SLEEPY&&o>i)this.wakeUp();else if(e===u.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit){this.sleep();this.dispatchEvent(u.sleepEvent)}}};u.prototype.updateSolveMassProperties=function(){if(this.sleepState===u.SLEEPING||this.type===u.KINEMATIC){this.invMassSolve=0;this.invInertiaSolve.setZero();this.invInertiaWorldSolve.setZero()}else{this.invMassSolve=this.invMass;this.invInertiaSolve.copy(this.invInertia);this.invInertiaWorldSolve.copy(this.invInertiaWorld)}};u.prototype.pointToLocalFrame=function(t,e){var e=e||new s;t.vsub(this.position,e);this.quaternion.conjugate().vmult(e,e);return e};u.prototype.vectorToLocalFrame=function(t,e){var e=e||new s;this.quaternion.conjugate().vmult(t,e);return e};u.prototype.pointToWorldFrame=function(t,e){var e=e||new s;this.quaternion.vmult(t,e);e.vadd(this.position,e);return e};u.prototype.vectorToWorldFrame=function(t,e){var e=e||new s;this.quaternion.vmult(t,e);return e};var c=new s,d=new a;u.prototype.addShape=function(t,e,o){var i=new s,n=new a;e&&i.copy(e);o&&n.copy(o);this.shapes.push(t);this.shapeOffsets.push(i);this.shapeOrientations.push(n);this.updateMassProperties();this.updateBoundingRadius();this.aabbNeedsUpdate=1;return this};u.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,o=t.length,i=0,n=0;n!==o;n++){var s=t[n];s.updateBoundingSphereRadius();var r=e[n].norm(),a=s.boundingSphereRadius;r+a>i&&(i=r+a)}this.boundingRadius=i};var v=new h;u.prototype.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,o=this.shapeOrientations,i=t.length,n=c,s=d,r=this.quaternion,a=this.aabb,l=v,h=0;h!==i;h++){var p=t[h];o[h].mult(r,s);s.vmult(e[h],n);n.vadd(this.position,n);p.calculateWorldAABB(n,s,l.lowerBound,l.upperBound);0===h?a.copy(l):a.extend(l)}this.aabbNeedsUpdate=0};var f=new r,y=new r,m=new r;u.prototype.updateInertiaWorld=function(t){var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var o=f,i=y,n=m;o.setRotationFromQuaternion(this.quaternion);o.transpose(i);o.scale(e,o);o.mmult(i,this.invInertiaWorld)}else;};var w=new s,x=new s;u.prototype.applyForce=function(t,e){if(this.type===u.DYNAMIC){var o=w;e.vsub(this.position,o);var i=x;o.cross(t,i);this.force.vadd(t,this.force);this.torque.vadd(i,this.torque)}};var g=new s,b=new s;u.prototype.applyLocalForce=function(t,e){if(this.type===u.DYNAMIC){var o=g,i=b;this.vectorToWorldFrame(t,o);this.pointToWorldFrame(e,i);this.applyForce(o,i)}};var B=new s,E=new s,A=new s;u.prototype.applyImpulse=function(t,e){if(this.type===u.DYNAMIC){var o=B;e.vsub(this.position,o);var i=E;i.copy(t);i.mult(this.invMass,i);this.velocity.vadd(i,this.velocity);var n=A;o.cross(t,n);this.invInertiaWorld.vmult(n,n);this.angularVelocity.vadd(n,this.angularVelocity)}};var S=new s,C=new s;u.prototype.applyLocalImpulse=function(t,e){if(this.type===u.DYNAMIC){var o=S,i=C;this.vectorToWorldFrame(t,o);this.pointToWorldFrame(e,i);this.applyImpulse(o,i)}};var z=new s;u.prototype.updateMassProperties=function(){var t=z;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,o=this.fixedRotation;this.computeAABB();t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2);p.calculateInertia(t,this.mass,e);this.invInertia.set(e.x>0&&!o?1/e.x:0,e.y>0&&!o?1/e.y:0,e.z>0&&!o?1/e.z:0);this.updateInertiaWorld(1)};u.prototype.getVelocityAtWorldPoint=function(t,e){var o=new s;t.vsub(this.position,o);this.angularVelocity.cross(o,e);this.velocity.vadd(e,e);return e}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(t,e,o){var i=t("./Body"),n=t("../math/Vec3"),s=t("../math/Quaternion"),r=t("../collision/RaycastResult"),a=t("../collision/Ray"),l=t("../objects/WheelInfo");e.exports=h;function h(t){this.chassisBody=t.chassisBody;this.wheelInfos=[];this.sliding=0;this.world=null;this.indexRightAxis="undefined"!=typeof t.indexRightAxis?t.indexRightAxis:1;this.indexForwardAxis="undefined"!=typeof t.indexForwardAxis?t.indexForwardAxis:0;this.indexUpAxis="undefined"!=typeof t.indexUpAxis?t.indexUpAxis:2}var p=new n,u=new n,c=new n,d=new n,v=new n,f=new n,y=new a;h.prototype.addWheel=function(t){var e=new l(t=t||{}),o=this.wheelInfos.length;this.wheelInfos.push(e);return o};h.prototype.setSteeringValue=function(t,e){var o;this.wheelInfos[e].steering=t};var m=new n;h.prototype.applyEngineForce=function(t,e){this.wheelInfos[e].engineForce=t};h.prototype.setBrake=function(t,e){this.wheelInfos[e].brake=t};h.prototype.addToWorld=function(t){var e=this.constraints;t.add(this.chassisBody);var o=this;this.preStepCallback=function(){o.updateVehicle(t.dt)};t.addEventListener("preStep",this.preStepCallback);this.world=t};h.prototype.getVehicleAxisWorld=function(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0);this.chassisBody.vectorToWorldFrame(e,e)};h.prototype.updateVehicle=function(t){for(var e=this.wheelInfos,o=e.length,i=this.chassisBody,s=0;s<o;s++)this.updateWheelTransform(s);this.currentVehicleSpeedKmHour=3.6*i.velocity.norm();var r=new n;this.getVehicleAxisWorld(this.indexForwardAxis,r);r.dot(i.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var s=0;s<o;s++)this.castRay(e[s]);this.updateSuspension(t);for(var a=new n,l=new n,s=0;s<o;s++){var h,p=(h=e[s]).suspensionForce;p>h.maxSuspensionForce&&(p=h.maxSuspensionForce);h.raycastResult.hitNormalWorld.scale(p*t,a);h.raycastResult.hitPointWorld.vsub(i.position,l);i.applyImpulse(a,h.raycastResult.hitPointWorld)}this.updateFriction(t);var u=new n,c=new n,d=new n;for(s=0;s<o;s++){var h=e[s];i.getVelocityAtWorldPoint(h.chassisConnectionPointWorld,d);var v=1;switch(this.indexUpAxis){case 1:v=-1;break}if(h.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,c);var f=c.dot(h.raycastResult.hitNormalWorld);h.raycastResult.hitNormalWorld.scale(f,u);c.vsub(u,c);var y=c.dot(d);h.deltaRotation=v*y*t/h.radius}!h.sliding&&h.isInContact||0===h.engineForce||!h.useCustomSlidingRotationalSpeed||(h.deltaRotation=(h.engineForce>0?1:-1)*h.customSlidingRotationalSpeed*t);Math.abs(h.brake)>Math.abs(h.engineForce)&&(h.deltaRotation=0);h.rotation+=h.deltaRotation;h.deltaRotation*=.99}};h.prototype.updateSuspension=function(t){for(var e,o=this.chassisBody.mass,i=this.wheelInfos,n=i.length,s=0;s<n;s++){var r=i[s];if(r.isInContact){var a,l,h,p=r.suspensionRestLength-r.suspensionLength;a=r.suspensionStiffness*p*r.clippedInvContactDotSuspension;var u=r.suspensionRelativeVelocity,c;a-=(c=u<0?r.dampingCompression:r.dampingRelaxation)*u;r.suspensionForce=a*o;r.suspensionForce<0&&(r.suspensionForce=0)}else r.suspensionForce=0}};h.prototype.removeFromWorld=function(t){var e=this.constraints;t.remove(this.chassisBody);t.removeEventListener("preStep",this.preStepCallback);this.world=null};var w=new n,x=new n;h.prototype.castRay=function(t){var e=w,o=x;this.updateWheelTransformWorld(t);var i=this.chassisBody,s=-1,r=t.suspensionRestLength+t.radius;t.directionWorld.scale(r,e);var a=t.chassisConnectionPointWorld;a.vadd(e,o);var l=t.raycastResult,h=0;l.reset();var p=i.collisionResponse;i.collisionResponse=0;this.world.rayTest(a,o,l);i.collisionResponse=p;var u=l.body;t.raycastResult.groundObject=0;if(u){s=l.distance;t.raycastResult.hitNormalWorld=l.hitNormalWorld;t.isInContact=1;var c=l.distance;t.suspensionLength=c-t.radius;var d=t.suspensionRestLength-t.maxSuspensionTravel,v=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<d&&(t.suspensionLength=d);if(t.suspensionLength>v){t.suspensionLength=v;t.raycastResult.reset()}var f=t.raycastResult.hitNormalWorld.dot(t.directionWorld),y=new n;i.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,y);var m=t.raycastResult.hitNormalWorld.dot(y);if(f>=-.1){t.suspensionRelativeVelocity=0;t.clippedInvContactDotSuspension=10}else{var g=-1/f;t.suspensionRelativeVelocity=m*g;t.clippedInvContactDotSuspension=g}}else{t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel;t.suspensionRelativeVelocity=0;t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld);t.clippedInvContactDotSuspension=1}return s};h.prototype.updateWheelTransformWorld=function(t){t.isInContact=0;var e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld);e.vectorToWorldFrame(t.directionLocal,t.directionWorld);e.vectorToWorldFrame(t.axleLocal,t.axleWorld)};h.prototype.updateWheelTransform=function(t){var e=d,o=v,i=f,n=this.wheelInfos[t];this.updateWheelTransformWorld(n);n.directionLocal.scale(-1,e);o.copy(n.axleLocal);e.cross(o,i);i.normalize();o.normalize();var r=n.steering,a=new s;a.setFromAxisAngle(e,r);var l=new s;l.setFromAxisAngle(o,n.rotation);var h=n.worldTransform.quaternion;this.chassisBody.quaternion.mult(a,h);h.mult(l,h);h.normalize();var p=n.worldTransform.position;p.copy(n.directionWorld);p.scale(n.suspensionLength,p);p.vadd(n.chassisConnectionPointWorld,p)};var g=[new n(1,0,0),new n(0,1,0),new n(0,0,1)];h.prototype.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform};var b=new n,B=[],E=[],A=1;h.prototype.updateFriction=function(t){for(var e=b,o=this.wheelInfos,i=o.length,s=this.chassisBody,r=E,a=B,l=0,h=0;h<i;h++){var p,u;(u=(p=o[h]).raycastResult.body)&&l++;p.sideImpulse=0;p.forwardImpulse=0;r[h]||(r[h]=new n);a[h]||(a[h]=new n)}for(var h=0;h<i;h++){var p,u;if(u=(p=o[h]).raycastResult.body){var c=a[h],d;this.getWheelTransformWorld(h).vectorToWorldFrame(g[this.indexRightAxis],c);var v=p.raycastResult.hitNormalWorld,f=c.dot(v);v.scale(f,e);c.vsub(e,c);c.normalize();v.cross(c,r[h]);r[h].normalize();p.sideImpulse=W(s,p.raycastResult.hitPointWorld,u,p.raycastResult.hitPointWorld,c);p.sideImpulse*=A}}var y=1,m=.5;this.sliding=0;for(var h=0;h<i;h++){var p,u=(p=o[h]).raycastResult.body,w=0;p.slipInfo=1;if(u){var x=0,S=p.brake?p.brake:x;w=q(s,u,p.raycastResult.hitPointWorld,r[h],S);var C=S/(w+=p.engineForce*t);p.slipInfo*=C}p.forwardImpulse=0;p.skidInfo=1;if(u){p.skidInfo=1;var z=p.suspensionForce*t*p.frictionSlip,M,R=z*z;p.forwardImpulse=w;var P=p.forwardImpulse*m,F=p.sideImpulse*y,V=P*P+F*F;p.sliding=0;if(V>R){this.sliding=1;p.sliding=1;var C=z/Math.sqrt(V);p.skidInfo*=C}}}if(this.sliding)for(var h=0;h<i;h++){var p;if(0!==(p=o[h]).sideImpulse&&p.skidInfo<1){p.forwardImpulse*=p.skidInfo;p.sideImpulse*=p.skidInfo}}for(var h=0;h<i;h++){var p=o[h],T=new n;T.copy(p.raycastResult.hitPointWorld);if(0!==p.forwardImpulse){var I=new n;r[h].scale(p.forwardImpulse,I);s.applyImpulse(I,T)}if(0!==p.sideImpulse){var u=p.raycastResult.body,N=new n;N.copy(p.raycastResult.hitPointWorld);var L=new n;a[h].scale(p.sideImpulse,L);s.pointToLocalFrame(T,T);T["xyz"[this.indexUpAxis]]*=p.rollInfluence;s.pointToWorldFrame(T,T);s.applyImpulse(L,T);L.scale(-1,L);u.applyImpulse(L,N)}}};var S=new n,C=new n,z=new n;function q(t,e,o,i,n){var s=0,r=o,a=S,l=C,h=z,p,u,c,d,v;t.getVelocityAtWorldPoint(r,a);e.getVelocityAtWorldPoint(r,l);a.vsub(l,h);n<(s=-i.dot(h)*(1/(V(t,o,i)+V(e,o,i))))&&(s=n);s<-n&&(s=-n);return s}var M=new n,R=new n,P=new n,F=new n;function V(t,e,o){var i=M,n=R,s=P,r=F;e.vsub(t.position,i);i.cross(o,n);t.invInertiaWorld.vmult(n,r);r.cross(i,s);return t.invMass+o.dot(s)}var T=new n,I=new n,N=new n;function W(t,e,o,i,n,s){var r;if(n.norm2()>1.1)return 0;var a=T,l=I,h=N,p,u,c,s;t.getVelocityAtWorldPoint(e,a);o.getVelocityAtWorldPoint(i,l);a.vsub(l,h);return-.2*n.dot(h)*(1/(t.invMass+o.invMass))}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(t,e,o){var i=t("./Body"),n=t("../shapes/Sphere"),s=t("../shapes/Box"),r=t("../math/Vec3"),a=t("../constraints/HingeConstraint");e.exports=l;function l(t){this.wheelBodies=[];this.coordinateSystem="undefined"==typeof t.coordinateSystem?new r(1,2,3):t.coordinateSystem.clone();this.chassisBody=t.chassisBody;if(!this.chassisBody){var e=new s(new r(5,2,.5));this.chassisBody=new i(1,e)}this.constraints=[];this.wheelAxes=[];this.wheelForces=[]}l.prototype.addWheel=function(t){var e=(t=t||{}).body;e||(e=new i(1,new n(1.2)));this.wheelBodies.push(e);this.wheelForces.push(0);var o=new r,s="undefined"!=typeof t.position?t.position.clone():new r,l=new r;this.chassisBody.pointToWorldFrame(s,l);e.position.set(l.x,l.y,l.z);var h="undefined"!=typeof t.axis?t.axis.clone():new r(0,1,0);this.wheelAxes.push(h);var p=new a(this.chassisBody,e,{pivotA:s,axisA:h,pivotB:r.ZERO,axisB:h,collideConnected:0});this.constraints.push(p);return this.wheelBodies.length-1};l.prototype.setSteeringValue=function(t,e){var o=this.wheelAxes[e],i=Math.cos(t),n=Math.sin(t),s=o.x,r=o.y;this.constraints[e].axisA.set(i*s-n*r,n*s+i*r,0)};l.prototype.setMotorSpeed=function(t,e){var o=this.constraints[e];o.enableMotor();o.motorTargetVelocity=t};l.prototype.disableMotor=function(t){var e;this.constraints[t].disableMotor()};var h=new r;l.prototype.setWheelForce=function(t,e){this.wheelForces[e]=t};l.prototype.applyWheelForce=function(t,e){var o=this.wheelAxes[e],i=this.wheelBodies[e],n=i.torque;o.scale(t,h);i.vectorToWorldFrame(h,h);n.vadd(h,n)};l.prototype.addToWorld=function(t){for(var e=this.constraints,o=this.wheelBodies.concat([this.chassisBody]),i=0;i<o.length;i++)t.add(o[i]);for(var i=0;i<e.length;i++)t.addConstraint(e[i]);t.addEventListener("preStep",this._update.bind(this))};l.prototype._update=function(){for(var t=this.wheelForces,e=0;e<t.length;e++)this.applyWheelForce(t[e],e)};l.prototype.removeFromWorld=function(t){for(var e=this.constraints,o=this.wheelBodies.concat([this.chassisBody]),i=0;i<o.length;i++)t.remove(o[i]);for(var i=0;i<e.length;i++)t.removeConstraint(e[i])};var p=new r;l.prototype.getWheelSpeed=function(t){var e=this.wheelAxes[t],o,i=this.wheelBodies[t].angularVelocity;this.chassisBody.vectorToWorldFrame(e,p);return i.dot(p)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(t,e,o){e.exports=h;var i=t("../shapes/Shape"),n=t("../math/Vec3"),s=t("../math/Quaternion"),r=t("../shapes/Particle"),a=t("../objects/Body"),l=t("../material/Material");function h(){this.particles=[];this.density=1;this.smoothingRadius=1;this.speedOfSound=1;this.viscosity=.01;this.eps=1e-6;this.pressures=[];this.densities=[];this.neighbors=[]}h.prototype.add=function(t){this.particles.push(t);this.neighbors.length<this.particles.length&&this.neighbors.push([])};h.prototype.remove=function(t){var e=this.particles.indexOf(t);if(-1!==e){this.particles.splice(e,1);this.neighbors.length>this.particles.length&&this.neighbors.pop()}};var p=new n;h.prototype.getNeighbors=function(t,e){for(var o=this.particles.length,i=t.id,n=this.smoothingRadius*this.smoothingRadius,s=p,r=0;r!==o;r++){var a=this.particles[r];a.position.vsub(t.position,s);i!==a.id&&s.norm2()<n&&e.push(a)}};var u=new n,c=new n,d=new n,v=new n,f=new n,y=new n;h.prototype.update=function(){for(var t=this.particles.length,e=u,o=this.speedOfSound,i=this.eps,n=0;n!==t;n++){var s=this.particles[n],r;(r=this.neighbors[n]).length=0;this.getNeighbors(s,r);r.push(this.particles[n]);for(var a=r.length,l=0,h=0;h!==a;h++){s.position.vsub(r[h].position,e);var p=e.norm(),m=this.w(p);l+=r[h].mass*m}this.densities[n]=l;this.pressures[n]=o*o*(this.densities[n]-this.density)}for(var w=c,x=d,g=v,b=f,B=y,n=0;n!==t;n++){var E=this.particles[n],A,S,C;w.set(0,0,0);x.set(0,0,0);for(var r,a=(r=this.neighbors[n]).length,h=0;h!==a;h++){var z=r[h];E.position.vsub(z.position,b);var q=b.norm();A=-z.mass*(this.pressures[n]/(this.densities[n]*this.densities[n]+i)+this.pressures[h]/(this.densities[h]*this.densities[h]+i));this.gradw(b,g);g.mult(A,g);w.vadd(g,w);z.velocity.vsub(E.velocity,B);B.mult(1/(1e-4+this.densities[n]*this.densities[h])*this.viscosity*z.mass,B);S=this.nablaw(q);B.mult(S,B);x.vadd(B,x)}x.mult(E.mass,x);w.mult(E.mass,w);E.force.vadd(x,E.force);E.force.vadd(w,E.force)}};h.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)};h.prototype.gradw=function(t,e){var o=t.norm(),i=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(i,9))*Math.pow(i*i-o*o,2),e)};h.prototype.nablaw=function(t){var e=this.smoothingRadius,o;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(t,e,o){var i=t("../math/Vec3");e.exports=n;function n(t,e,o){o=o||{};this.restLength="number"==typeof o.restLength?o.restLength:1;this.stiffness=o.stiffness||100;this.damping=o.damping||1;this.bodyA=t;this.bodyB=e;this.localAnchorA=new i;this.localAnchorB=new i;o.localAnchorA&&this.localAnchorA.copy(o.localAnchorA);o.localAnchorB&&this.localAnchorB.copy(o.localAnchorB);o.worldAnchorA&&this.setWorldAnchorA(o.worldAnchorA);o.worldAnchorB&&this.setWorldAnchorB(o.worldAnchorB)}n.prototype.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)};n.prototype.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)};n.prototype.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)};n.prototype.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)};var s=new i,r=new i,a=new i,l=new i,h=new i,p=new i,u=new i,c=new i,d=new i,v=new i,f=new i;n.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,o=this.restLength,i=this.bodyA,n=this.bodyB,y=s,m=r,w=a,x=l,g=f,b=h,B=p,E=u,A=c,S=d,C=v;this.getWorldAnchorA(b);this.getWorldAnchorB(B);b.vsub(i.position,E);B.vsub(n.position,A);B.vsub(b,y);var z=y.norm();m.copy(y);m.normalize();n.velocity.vsub(i.velocity,w);n.angularVelocity.cross(A,g);w.vadd(g,w);i.angularVelocity.cross(E,g);w.vsub(g,w);m.mult(-t*(z-o)-e*w.dot(m),x);i.force.vsub(x,i.force);n.force.vadd(x,n.force);E.cross(x,S);A.cross(x,C);i.torque.vsub(S,i.torque);n.torque.vadd(C,n.torque)}},{"../math/Vec3":30}],36:[function(t,e,o){var i=t("../math/Vec3"),n=t("../math/Transform"),s=t("../collision/RaycastResult"),r=t("../utils/Utils");e.exports=a;function a(t){t=r.defaults(t,{chassisConnectionPointLocal:new i,chassisConnectionPointWorld:new i,directionLocal:new i,directionWorld:new i,axleLocal:new i,axleWorld:new i,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:1,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:0,customSlidingRotationalSpeed:-.1});this.maxSuspensionTravel=t.maxSuspensionTravel;this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed;this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed;this.sliding=0;this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone();this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone();this.directionLocal=t.directionLocal.clone();this.directionWorld=t.directionWorld.clone();this.axleLocal=t.axleLocal.clone();this.axleWorld=t.axleWorld.clone();this.suspensionRestLength=t.suspensionRestLength;this.suspensionMaxLength=t.suspensionMaxLength;this.radius=t.radius;this.suspensionStiffness=t.suspensionStiffness;this.dampingCompression=t.dampingCompression;this.dampingRelaxation=t.dampingRelaxation;this.frictionSlip=t.frictionSlip;this.steering=0;this.rotation=0;this.deltaRotation=0;this.rollInfluence=t.rollInfluence;this.maxSuspensionForce=t.maxSuspensionForce;this.engineForce=0;this.brake=0;this.isFrontWheel=t.isFrontWheel;this.clippedInvContactDotSuspension=1;this.suspensionRelativeVelocity=0;this.suspensionForce=0;this.skidInfo=0;this.suspensionLength=0;this.sideImpulse=0;this.forwardImpulse=0;this.raycastResult=new s;this.worldTransform=new n;this.isInContact=0}var l=new i,h=new i,l=new i;a.prototype.updateWheel=function(t){var e=this.raycastResult;if(this.isInContact){var o=e.hitNormalWorld.dot(e.directionWorld);e.hitPointWorld.vsub(t.position,h);t.getVelocityAtWorldPoint(h,l);var i=e.hitNormalWorld.dot(l);if(o>=-.1){this.suspensionRelativeVelocity=0;this.clippedInvContactDotSuspension=10}else{var n=-1/o;this.suspensionRelativeVelocity=i*n;this.clippedInvContactDotSuspension=n}}else{e.suspensionLength=this.suspensionRestLength;this.suspensionRelativeVelocity=0;e.directionWorld.scale(-1,e.hitNormalWorld);this.clippedInvContactDotSuspension=1}}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(t,e,o){e.exports=r;var i=t("./Shape"),n=t("../math/Vec3"),s=t("./ConvexPolyhedron");function r(t){i.call(this);this.type=i.types.BOX;this.halfExtents=t;this.convexPolyhedronRepresentation=null;this.updateConvexPolyhedronRepresentation();this.updateBoundingSphereRadius()}r.prototype=new i;r.prototype.constructor=r;r.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,o=this.halfExtents.z,i=n,r=[new i(-t,-e,-o),new i(t,-e,-o),new i(t,e,-o),new i(-t,e,-o),new i(-t,-e,o),new i(t,-e,o),new i(t,e,o),new i(-t,e,o)],a=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],l=[new i(0,0,1),new i(0,1,0),new i(1,0,0)],h=new s(r,a);this.convexPolyhedronRepresentation=h;h.material=this.material};r.prototype.calculateLocalInertia=function(t,e){e=e||new n;r.calculateInertia(this.halfExtents,t,e);return e};r.calculateInertia=function(t,e,o){var i=t;o.x=1/12*e*(2*i.y*2*i.y+2*i.z*2*i.z);o.y=1/12*e*(2*i.x*2*i.x+2*i.z*2*i.z);o.z=1/12*e*(2*i.y*2*i.y+2*i.x*2*i.x)};r.prototype.getSideNormals=function(t,e){var o=t,i=this.halfExtents;o[0].set(i.x,0,0);o[1].set(0,i.y,0);o[2].set(0,0,i.z);o[3].set(-i.x,0,0);o[4].set(0,-i.y,0);o[5].set(0,0,-i.z);if(void 0!==e)for(var n=0;n!==o.length;n++)e.vmult(o[n],o[n]);return o};r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z};r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var a=new n,l=new n;r.prototype.forEachWorldCorner=function(t,e,o){for(var i=this.halfExtents,n=[[i.x,i.y,i.z],[-i.x,i.y,i.z],[-i.x,-i.y,i.z],[-i.x,-i.y,-i.z],[i.x,-i.y,-i.z],[i.x,i.y,-i.z],[-i.x,i.y,-i.z],[i.x,-i.y,i.z]],s=0;s<n.length;s++){a.set(n[s][0],n[s][1],n[s][2]);e.vmult(a,a);t.vadd(a,a);o(a.x,a.y,a.z)}};var h=[new n,new n,new n,new n,new n,new n,new n,new n];r.prototype.calculateWorldAABB=function(t,e,o,i){var n=this.halfExtents;h[0].set(n.x,n.y,n.z);h[1].set(-n.x,n.y,n.z);h[2].set(-n.x,-n.y,n.z);h[3].set(-n.x,-n.y,-n.z);h[4].set(n.x,-n.y,-n.z);h[5].set(n.x,n.y,-n.z);h[6].set(-n.x,n.y,-n.z);h[7].set(n.x,-n.y,n.z);var s=h[0];e.vmult(s,s);t.vadd(s,s);i.copy(s);o.copy(s);for(var r=1;r<8;r++){var s=h[r];e.vmult(s,s);t.vadd(s,s);var a=s.x,l=s.y,p=s.z;a>i.x&&(i.x=a);l>i.y&&(i.y=l);p>i.z&&(i.z=p);a<o.x&&(o.x=a);l<o.y&&(o.y=l);p<o.z&&(o.z=p)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(t,e,o){e.exports=a;var i=t("./Shape"),n=t("../math/Vec3"),s=t("../math/Quaternion"),r=t("../math/Transform");function a(t,e,o){var n=this;i.call(this);this.type=i.types.CONVEXPOLYHEDRON;this.vertices=t||[];this.worldVertices=[];this.worldVerticesNeedsUpdate=1;this.faces=e||[];this.faceNormals=[];this.computeNormals();this.worldFaceNormalsNeedsUpdate=1;this.worldFaceNormals=[];this.uniqueEdges=[];this.uniqueAxes=o?o.slice():null;this.computeEdges();this.updateBoundingSphereRadius()}a.prototype=new i;a.prototype.constructor=a;var l=new n;a.prototype.computeEdges=function(){var t=this.faces,e=this.vertices,o=e.length,i=this.uniqueEdges;i.length=0;for(var n=l,s=0;s!==t.length;s++)for(var r=t[s],a=r.length,h=0;h!==a;h++){var p=(h+1)%a;e[r[h]].vsub(e[r[p]],n);n.normalize();for(var u=0,c=0;c!==i.length;c++)if(i[c].almostEquals(n)||i[c].almostEquals(n)){u=1;break}u||i.push(n.clone())}};a.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var e=0;e<this.faces[t].length;e++)if(!this.vertices[this.faces[t][e]])throw new Error("Vertex "+this.faces[t][e]+" not found!");var o=this.faceNormals[t]||new n;this.getFaceNormal(t,o);o.negate(o);this.faceNormals[t]=o;var i=this.vertices[this.faces[t][0]];if(o.dot(i)<0){void 0;for(var e=0;e<this.faces[t].length;e++)void 0}}};var h=new n,p=new n;a.computeNormal=function(t,e,o,i){e.vsub(t,p);o.vsub(e,h);h.cross(p,i);i.isZero()||i.normalize()};a.prototype.getFaceNormal=function(t,e){var o=this.faces[t],i=this.vertices[o[0]],n=this.vertices[o[1]],s=this.vertices[o[2]];return a.computeNormal(i,n,s,e)};var u=new n;a.prototype.clipAgainstHull=function(t,e,o,i,s,r,a,l,h){for(var p=u,c=this,d=l,v=-1,f=-Number.MAX_VALUE,y=0;y<o.faces.length;y++){p.copy(o.faceNormals[y]);s.vmult(p,p);var m=p.dot(r);if(m>f){f=m;v=y}}for(var w=[],x=o.faces[v],g=x.length,b=0;b<g;b++){var B=o.vertices[x[b]],E=new n;E.copy(B);s.vmult(E,E);i.vadd(E,E);w.push(E)}v>=0&&this.clipFaceAgainstHull(r,t,e,w,a,l,h)};var c=new n,d=new n,v=new n,f=new n,y=new n,m=new n;a.prototype.findSeparatingAxis=function(t,e,o,i,n,s,r,a){var l=c,h=d,p=v,u=f,w=y,x=m,g=Number.MAX_VALUE,b=this,B=0;if(b.uniqueAxes)for(var E=0;E!==b.uniqueAxes.length;E++){o.vmult(b.uniqueAxes[E],l);var A;if(0==(A=b.testSepAxis(l,t,e,o,i,n)))return 0;if(A<g){g=A;s.copy(l)}}else for(var S=r?r.length:b.faces.length,E=0;E<S;E++){var C=r?r[E]:E,A;l.copy(b.faceNormals[C]);o.vmult(l,l);if(0==(A=b.testSepAxis(l,t,e,o,i,n)))return 0;if(A<g){g=A;s.copy(l)}}if(t.uniqueAxes)for(var E=0;E!==t.uniqueAxes.length;E++){n.vmult(t.uniqueAxes[E],h);B++;var A;if(0==(A=b.testSepAxis(h,t,e,o,i,n)))return 0;if(A<g){g=A;s.copy(h)}}else for(var z=a?a.length:t.faces.length,E=0;E<z;E++){var C=a?a[E]:E,A;h.copy(t.faceNormals[C]);n.vmult(h,h);B++;if(0==(A=b.testSepAxis(h,t,e,o,i,n)))return 0;if(A<g){g=A;s.copy(h)}}for(var q=0;q!==b.uniqueEdges.length;q++){o.vmult(b.uniqueEdges[q],u);for(var M=0;M!==t.uniqueEdges.length;M++){n.vmult(t.uniqueEdges[M],w);u.cross(w,x);if(!x.almostZero()){x.normalize();var R=b.testSepAxis(x,t,e,o,i,n);if(0==R)return 0;if(R<g){g=R;s.copy(x)}}}}i.vsub(e,p);p.dot(s)>0&&s.negate(s);return 1};var w=[],x=[];a.prototype.testSepAxis=function(t,e,o,i,n,s){var r=this;a.project(r,t,o,i,w);a.project(e,t,n,s,x);var l=w[0],h=w[1],p=x[0],u=x[1];if(l<u||p<h)return 0;var c=l-u,d=p-h,v;return c<d?c:d};var g=new n,b=new n;a.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(g,b);var o=b.x-g.x,i=b.y-g.y,n=b.z-g.z;e.x=1/12*t*(2*i*2*i+2*n*2*n);e.y=1/12*t*(2*o*2*o+2*n*2*n);e.z=1/12*t*(2*i*2*i+2*o*2*o)};a.prototype.getPlaneConstantOfFace=function(t){var e=this.faces[t],o=this.faceNormals[t],i=this.vertices[e[0]],n;return-o.dot(i)};var B=new n,E=new n,A=new n,S=new n,C=new n,z=new n,q=new n,M=new n;a.prototype.clipFaceAgainstHull=function(t,e,o,i,n,s,r){for(var a=B,l=E,h=A,p=S,u=C,c=z,d=q,v=M,f=this,y,m=i,w=[],x=-1,g=Number.MAX_VALUE,b=0;b<f.faces.length;b++){a.copy(f.faceNormals[b]);o.vmult(a,a);var R=a.dot(t);if(R<g){g=R;x=b}}if(!(x<0)){var P=f.faces[x];P.connectedFaces=[];for(var F=0;F<f.faces.length;F++)for(var V=0;V<f.faces[F].length;V++)-1!==P.indexOf(f.faces[F][V])&&F!==x&&-1===P.connectedFaces.indexOf(F)&&P.connectedFaces.push(F);for(var T=m.length,I=P.length,N=[],W=0;W<I;W++){var L=f.vertices[P[W]],j=f.vertices[P[(W+1)%I]];L.vsub(j,l);h.copy(l);o.vmult(h,h);e.vadd(h,h);p.copy(this.faceNormals[x]);o.vmult(p,p);e.vadd(p,p);h.cross(p,u);u.negate(u);c.copy(L);o.vmult(c,c);e.vadd(c,c);var O=-c.dot(u),_;1;var k=P.connectedFaces[W];d.copy(this.faceNormals[k]);var U=this.getPlaneConstantOfFace(k);v.copy(d);o.vmult(v,v);var _=U-v.dot(e);this.clipFaceAgainstPlane(m,w,v,_);for(;m.length;)m.shift();for(;w.length;)m.push(w.shift())}d.copy(this.faceNormals[x]);var U=this.getPlaneConstantOfFace(x);v.copy(d);o.vmult(v,v);for(var _=U-v.dot(e),F=0;F<m.length;F++){var H=v.dot(m[F])+_;if(H<=n){void 0;H=n}if(H<=s){var D=m[F];if(H<=0){var X={point:D,normal:v,depth:H};r.push(X)}}}}};a.prototype.clipFaceAgainstPlane=function(t,e,o,i){var s,r,a=t.length;if(a<2)return e;var l=t[t.length-1],h=t[0];s=o.dot(l)+i;for(var p=0;p<a;p++){h=t[p];r=o.dot(h)+i;if(s<0)if(r<0){var u;(u=new n).copy(h);e.push(u)}else{var u=new n;l.lerp(h,s/(s-r),u);e.push(u)}else if(r<0){var u=new n;l.lerp(h,s/(s-r),u);e.push(u);e.push(h)}l=h;s=r}return e};a.prototype.computeWorldVertices=function(t,e){for(var o=this.vertices.length;this.worldVertices.length<o;)this.worldVertices.push(new n);for(var i=this.vertices,s=this.worldVertices,r=0;r!==o;r++){e.vmult(i[r],s[r]);t.vadd(s[r],s[r])}this.worldVerticesNeedsUpdate=0};var R=new n;a.prototype.computeLocalAABB=function(t,e){var o=this.vertices.length,i=this.vertices,n=R;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var s=0;s<o;s++){var r=i[s];r.x<t.x?t.x=r.x:r.x>e.x&&(e.x=r.x);r.y<t.y?t.y=r.y:r.y>e.y&&(e.y=r.y);r.z<t.z?t.z=r.z:r.z>e.z&&(e.z=r.z)}};a.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new n);for(var o=this.faceNormals,i=this.worldFaceNormals,s=0;s!==e;s++)t.vmult(o[s],i[s]);this.worldFaceNormalsNeedsUpdate=0};a.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,o=0,i=e.length;o!==i;o++){var n=e[o].norm2();n>t&&(t=n)}this.boundingSphereRadius=Math.sqrt(t)};var P=new n;a.prototype.calculateWorldAABB=function(t,e,o,i){for(var n=this.vertices.length,s=this.vertices,r,a,l,h,p,u,c=0;c<n;c++){P.copy(s[c]);e.vmult(P,P);t.vadd(P,P);var d=P;d.x<r||void 0===r?r=d.x:(d.x>h||void 0===h)&&(h=d.x);d.y<a||void 0===a?a=d.y:(d.y>p||void 0===p)&&(p=d.y);d.z<l||void 0===l?l=d.z:(d.z>u||void 0===u)&&(u=d.z)}o.set(r,a,l);i.set(h,p,u)};a.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};a.prototype.getAveragePointLocal=function(t){t=t||new n;for(var e=this.vertices.length,o=this.vertices,i=0;i<e;i++)t.vadd(o[i],t);t.mult(1/e,t);return t};a.prototype.transformAllPoints=function(t,e){var o=this.vertices.length,i=this.vertices;if(e){for(var n=0;n<o;n++){var s=i[n];e.vmult(s,s)}for(var n=0;n<this.faceNormals.length;n++){var s=this.faceNormals[n];e.vmult(s,s)}}if(t)for(var n=0;n<o;n++){var s;(s=i[n]).vadd(t,s)}};var F=new n,V=new n,T=new n;a.prototype.pointIsInside=function(t){var e=this.vertices.length,o=this.vertices,i=this.faces,n=this.faceNormals,s=null,r=this.faces.length,a=F;this.getAveragePointLocal(a);for(var l=0;l<r;l++){var h=this.faces[l].length,e=n[l],p=o[i[l][0]],u=V;t.vsub(p,u);var c=e.dot(u),d=T;a.vsub(p,d);var v=e.dot(d);if(c<0&&v>0||c>0&&v<0)return 0}return s?1:-1};var I=new n,N=new n,W=new n;a.project=function(t,e,o,i,n){var s=t.vertices.length,a=I,l=N,h=0,p=0,u=W,c=t.vertices;u.setZero();r.vectorToLocalFrame(o,i,e,l);r.pointToLocalFrame(o,i,u,u);var d=u.dot(l);p=h=c[0].dot(l);for(var v=1;v<s;v++){var f=c[v].dot(l);f>h&&(h=f);f<p&&(p=f)}if((p-=d)>(h-=d)){var y=p;p=h;h=y}n[0]=h;n[1]=p}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(t,e,o){e.exports=a;var i=t("./Shape"),n=t("../math/Vec3"),s=t("../math/Quaternion"),r=t("./ConvexPolyhedron");function a(t,e,o,s){var a=s,l=[],h=[],p=[],u=[],c=[],d=Math.cos,v=Math.sin;l.push(new n(e*d(0),e*v(0),.5*-o));u.push(0);l.push(new n(t*d(0),t*v(0),.5*o));c.push(1);for(var f=0;f<a;f++){var y=2*Math.PI/a*(f+1),m=2*Math.PI/a*(f+.5);if(f<a-1){l.push(new n(e*d(y),e*v(y),.5*-o));u.push(2*f+2);l.push(new n(t*d(y),t*v(y),.5*o));c.push(2*f+3);p.push([2*f+2,2*f+3,2*f+1,2*f])}else p.push([0,1,2*f+1,2*f]);(a%2==1||f<a/2)&&h.push(new n(d(m),v(m),0))}p.push(c);h.push(new n(0,0,1));for(var w=[],f=0;f<u.length;f++)w.push(u[u.length-f-1]);p.push(w);this.type=i.types.CONVEXPOLYHEDRON;r.call(this,l,p,h)}a.prototype=new r},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(t,e,o){var i=t("./Shape"),n=t("./ConvexPolyhedron"),s=t("../math/Vec3"),r=t("../utils/Utils");e.exports=a;function a(t,e){e=r.defaults(e,{maxValue:null,minValue:null,elementSize:1});this.data=t;this.maxValue=e.maxValue;this.minValue=e.minValue;this.elementSize=e.elementSize;null===e.minValue&&this.updateMinValue();null===e.maxValue&&this.updateMaxValue();this.cacheEnabled=1;i.call(this);this.pillarConvex=new n;this.pillarOffset=new s;this.type=i.types.HEIGHTFIELD;this.updateBoundingSphereRadius();this._cachedPillars={}}a.prototype=new i;a.prototype.update=function(){this._cachedPillars={}};a.prototype.updateMinValue=function(){for(var t=this.data,e=t[0][0],o=0;o!==t.length;o++)for(var i=0;i!==t[o].length;i++){var n=t[o][i];n<e&&(e=n)}this.minValue=e};a.prototype.updateMaxValue=function(){for(var t=this.data,e=t[0][0],o=0;o!==t.length;o++)for(var i=0;i!==t[o].length;i++){var n=t[o][i];n>e&&(e=n)}this.maxValue=e};a.prototype.setHeightValueAtIndex=function(t,e,o){var i;this.data[t][e]=o;this.clearCachedConvexTrianglePillar(t,e,0);if(t>0){this.clearCachedConvexTrianglePillar(t-1,e,1);this.clearCachedConvexTrianglePillar(t-1,e,0)}if(e>0){this.clearCachedConvexTrianglePillar(t,e-1,1);this.clearCachedConvexTrianglePillar(t,e-1,0)}e>0&&t>0&&this.clearCachedConvexTrianglePillar(t-1,e-1,1)};a.prototype.getRectMinMax=function(t,e,o,i,n){n=n||[];for(var s=this.data,r=this.minValue,a=t;a<=o;a++)for(var l=e;l<=i;l++){var h=s[a][l];h>r&&(r=h)}n[0]=this.minValue;n[1]=r};a.prototype.getIndexOfPosition=function(t,e,o,i){var n=this.elementSize,s=this.data,r=Math.floor(t/n),a=Math.floor(e/n);o[0]=r;o[1]=a;if(i){r<0&&(r=0);a<0&&(a=0);r>=s.length-1&&(r=s.length-1);a>=s[0].length-1&&(a=s[0].length-1)}return r<0||a<0||r>=s.length-1||a>=s[0].length-1?0:1};a.prototype.getHeightAt=function(t,e,o){var i=[];this.getIndexOfPosition(t,e,i,o);var n=[];this.getRectMinMax(i[0],i[1]+1,i[0],i[1]+1,n);return(n[0]+n[1])/2};a.prototype.getCacheConvexTrianglePillarKey=function(t,e,o){return t+"_"+e+"_"+(o?1:0)};a.prototype.getCachedConvexTrianglePillar=function(t,e,o){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,o)]};a.prototype.setCachedConvexTrianglePillar=function(t,e,o,i,n){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,o)]={convex:i,offset:n}};a.prototype.clearCachedConvexTrianglePillar=function(t,e,o){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,o)]};a.prototype.getConvexTrianglePillar=function(t,e,o){var i=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){var a;if(a=this.getCachedConvexTrianglePillar(t,e,o)){this.pillarConvex=a.convex;this.pillarOffset=a.offset;return}i=new n;r=new s;this.pillarConvex=i;this.pillarOffset=r}var a=this.data,l=this.elementSize,h=i.faces;i.vertices.length=6;for(var p=0;p<6;p++)i.vertices[p]||(i.vertices[p]=new s);h.length=5;for(var p=0;p<5;p++)h[p]||(h[p]=[]);var u=i.vertices,c=(Math.min(a[t][e],a[t+1][e],a[t][e+1],a[t+1][e+1])-this.minValue)/2+this.minValue;if(o){r.set((t+.75)*l,(e+.75)*l,c);u[0].set(.25*l,.25*l,a[t+1][e+1]-c);u[1].set(-.75*l,.25*l,a[t][e+1]-c);u[2].set(.25*l,-.75*l,a[t+1][e]-c);u[3].set(.25*l,.25*l,-c-1);u[4].set(-.75*l,.25*l,-c-1);u[5].set(.25*l,-.75*l,-c-1);h[0][0]=0;h[0][1]=1;h[0][2]=2;h[1][0]=5;h[1][1]=4;h[1][2]=3;h[2][0]=2;h[2][1]=5;h[2][2]=3;h[2][3]=0;h[3][0]=3;h[3][1]=4;h[3][2]=1;h[3][3]=0;h[4][0]=1;h[4][1]=4;h[4][2]=5;h[4][3]=2}else{r.set((t+.25)*l,(e+.25)*l,c);u[0].set(-.25*l,-.25*l,a[t][e]-c);u[1].set(.75*l,-.25*l,a[t+1][e]-c);u[2].set(-.25*l,.75*l,a[t][e+1]-c);u[3].set(-.25*l,-.25*l,-c-1);u[4].set(.75*l,-.25*l,-c-1);u[5].set(-.25*l,.75*l,-c-1);h[0][0]=0;h[0][1]=1;h[0][2]=2;h[1][0]=5;h[1][1]=4;h[1][2]=3;h[2][0]=0;h[2][1]=2;h[2][2]=5;h[2][3]=3;h[3][0]=1;h[3][1]=0;h[3][2]=3;h[3][3]=4;h[4][0]=4;h[4][1]=5;h[4][2]=2;h[4][3]=1}i.computeNormals();i.computeEdges();i.updateBoundingSphereRadius();this.setCachedConvexTrianglePillar(t,e,o,i,r)};a.prototype.calculateLocalInertia=function(t,e){(e=e||new s).set(0,0,0);return e};a.prototype.volume=function(){return Number.MAX_VALUE};a.prototype.calculateWorldAABB=function(t,e,o,i){o.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);i.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};a.prototype.updateBoundingSphereRadius=function(){var t=this.data,e=this.elementSize;this.boundingSphereRadius=new s(t.length*e,t[0].length*e,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(t,e,o){e.exports=s;var i=t("./Shape"),n=t("../math/Vec3");function s(){i.call(this);this.type=i.types.PARTICLE}s.prototype=new i;s.prototype.constructor=s;s.prototype.calculateLocalInertia=function(t,e){(e=e||new n).set(0,0,0);return e};s.prototype.volume=function(){return 0};s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0};s.prototype.calculateWorldAABB=function(t,e,o,i){o.copy(t);i.copy(t)}},{"../math/Vec3":30,"./Shape":43}],42:[function(t,e,o){e.exports=s;var i=t("./Shape"),n=t("../math/Vec3");function s(){i.call(this);this.type=i.types.PLANE;this.worldNormal=new n;this.worldNormalNeedsUpdate=1;this.boundingSphereRadius=Number.MAX_VALUE}s.prototype=new i;s.prototype.constructor=s;s.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1);t.vmult(e,e);this.worldNormalNeedsUpdate=0};s.prototype.calculateLocalInertia=function(t,e){return e=e||new n};s.prototype.volume=function(){return Number.MAX_VALUE};var r=new n;s.prototype.calculateWorldAABB=function(t,e,o,i){r.set(0,0,1);e.vmult(r,r);var n=Number.MAX_VALUE;o.set(-n,-n,-n);i.set(n,n,n);1===r.x&&(i.x=t.x);1===r.y&&(i.y=t.y);1===r.z&&(i.z=t.z);-1===r.x&&(o.x=t.x);-1===r.y&&(o.y=t.y);-1===r.z&&(o.z=t.z)};s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(t,e,o){e.exports=i;var i=t("./Shape"),n=t("../math/Vec3"),s=t("../math/Quaternion"),r=t("../material/Material");function i(){this.id=i.idCounter++;this.type=0;this.boundingSphereRadius=0;this.collisionResponse=1;this.material=null}i.prototype.constructor=i;i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type};i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type};i.prototype.calculateLocalInertia=function(t,e){throw"calculateLocalInertia() not implemented for shape type "+this.type};i.idCounter=0;i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(t,e,o){e.exports=s;var i=t("./Shape"),n=t("../math/Vec3");function s(t){i.call(this);this.radius=void 0!==t?Number(t):1;this.type=i.types.SPHERE;if(this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}s.prototype=new i;s.prototype.constructor=s;s.prototype.calculateLocalInertia=function(t,e){e=e||new n;var o=2*t*this.radius*this.radius/5;e.x=o;e.y=o;e.z=o;return e};s.prototype.volume=function(){return 4*Math.PI*this.radius/3};s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius};s.prototype.calculateWorldAABB=function(t,e,o,i){for(var n=this.radius,s=["x","y","z"],r=0;r<s.length;r++){var a=s[r];o[a]=t[a]-n;i[a]=t[a]+n}}},{"../math/Vec3":30,"./Shape":43}],45:[function(t,e,o){e.exports=h;var i=t("./Shape"),n=t("../math/Vec3"),s=t("../math/Quaternion"),r=t("../math/Transform"),a=t("../collision/AABB"),l=t("../utils/Octree");function h(t,e){i.call(this);this.type=i.types.TRIMESH;this.vertices=new Float32Array(t);this.indices=new Int16Array(e);this.normals=new Float32Array(e.length);this.aabb=new a;this.edges=null;this.scale=new n(1,1,1);this.tree=new l;this.updateEdges();this.updateNormals();this.updateAABB();this.updateBoundingSphereRadius();this.updateTree()}h.prototype=new i;h.prototype.constructor=h;var p=new n;h.prototype.updateTree=function(){var t=this.tree;t.reset();t.aabb.copy(this.aabb);var e=this.scale;t.aabb.lowerBound.x*=1/e.x;t.aabb.lowerBound.y*=1/e.y;t.aabb.lowerBound.z*=1/e.z;t.aabb.upperBound.x*=1/e.x;t.aabb.upperBound.y*=1/e.y;t.aabb.upperBound.z*=1/e.z;for(var o=new a,i=new n,s=new n,r=new n,l=[i,s,r],h=0;h<this.indices.length/3;h++){var p=3*h;this._getUnscaledVertex(this.indices[p],i);this._getUnscaledVertex(this.indices[p+1],s);this._getUnscaledVertex(this.indices[p+2],r);o.setFromPoints(l);t.insert(o,h)}t.removeEmptyNodes()};var u=new a;h.prototype.getTrianglesInAABB=function(t,e){u.copy(t);var o=this.scale,i=o.x,n=o.y,s=o.z,r=u.lowerBound,a=u.upperBound;r.x/=i;r.y/=n;r.z/=s;a.x/=i;a.y/=n;a.z/=s;return this.tree.aabbQuery(u,e)};h.prototype.setScale=function(t){var e=this.scale.x===this.scale.y===this.scale.z,o=t.x===t.y===t.z;e&&o||this.updateNormals();this.scale.copy(t);this.updateAABB();this.updateBoundingSphereRadius()};h.prototype.updateNormals=function(){for(var t=p,e=this.normals,o=0;o<this.indices.length/3;o++){var i=3*o,n=this.indices[i],s=this.indices[i+1],r=this.indices[i+2];this.getVertex(n,y);this.getVertex(s,m);this.getVertex(r,w);h.computeNormal(m,y,w,t);e[i]=t.x;e[i+1]=t.y;e[i+2]=t.z}};h.prototype.updateEdges=function(){for(var t={},e=function(e,o){var i;t[n<s?n+"_"+s:s+"_"+n]=1},o=0;o<this.indices.length/3;o++){var i=3*o,n=this.indices[i],s=this.indices[i+1],r=this.indices[i+2];e(n,s);e(s,r);e(r,n)}var a=Object.keys(t);this.edges=new Int16Array(2*a.length);for(var o=0;o<a.length;o++){var l=a[o].split("_");this.edges[2*o]=parseInt(l[0],10);this.edges[2*o+1]=parseInt(l[1],10)}};h.prototype.getEdgeVertex=function(t,e,o){var i=this.edges[2*t+(e?1:0)];this.getVertex(i,o)};var c=new n,d=new n;h.prototype.getEdgeVector=function(t,e){var o=c,i=d;this.getEdgeVertex(t,0,o);this.getEdgeVertex(t,1,i);i.vsub(o,e)};var v=new n,f=new n;h.computeNormal=function(t,e,o,i){e.vsub(t,f);o.vsub(e,v);v.cross(f,i);i.isZero()||i.normalize()};var y=new n,m=new n,w=new n;h.prototype.getVertex=function(t,e){var o=this.scale;this._getUnscaledVertex(t,e);e.x*=o.x;e.y*=o.y;e.z*=o.z;return e};h.prototype._getUnscaledVertex=function(t,e){var o=3*t,i=this.vertices;return e.set(i[o],i[o+1],i[o+2])};h.prototype.getWorldVertex=function(t,e,o,i){this.getVertex(t,i);r.pointToWorldFrame(e,o,i,i);return i};h.prototype.getTriangleVertices=function(t,e,o,i){var n=3*t;this.getVertex(this.indices[n],e);this.getVertex(this.indices[n+1],o);this.getVertex(this.indices[n+2],i)};h.prototype.getNormal=function(t,e){var o=3*t;return e.set(this.normals[o],this.normals[o+1],this.normals[o+2])};var x=new a;h.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(x);var o=x.upperBound.x-x.lowerBound.x,i=x.upperBound.y-x.lowerBound.y,n=x.upperBound.z-x.lowerBound.z;return e.set(1/12*t*(2*i*2*i+2*n*2*n),1/12*t*(2*o*2*o+2*n*2*n),1/12*t*(2*i*2*i+2*o*2*o))};var g=new n;h.prototype.computeLocalAABB=function(t){var e=t.lowerBound,o=t.upperBound,i=this.vertices.length,n=this.vertices,s=g;this.getVertex(0,s);e.copy(s);o.copy(s);for(var r=0;r!==i;r++){this.getVertex(r,s);s.x<e.x?e.x=s.x:s.x>o.x&&(o.x=s.x);s.y<e.y?e.y=s.y:s.y>o.y&&(o.y=s.y);s.z<e.z?e.z=s.z:s.z>o.z&&(o.z=s.z)}};h.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)};h.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,o=new n,i=0,s=e.length/3;i!==s;i++){this.getVertex(i,o);var r=o.norm2();r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t)};var b=new n,B=new r,E=new a;h.prototype.calculateWorldAABB=function(t,e,o,i){var n=B,s=E;n.position=t;n.quaternion=e;this.aabb.toWorldFrame(n,s);o.copy(s.lowerBound);i.copy(s.upperBound)};h.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};h.createTorus=function(t,e,o,i,n){t=t||1;e=e||.5;o=o||8;i=i||6;n=n||2*Math.PI;for(var s=[],r=[],a=0;a<=o;a++)for(var l=0;l<=i;l++){var p=l/i*n,u=a/o*Math.PI*2,c=(t+e*Math.cos(u))*Math.cos(p),d=(t+e*Math.cos(u))*Math.sin(p),v=e*Math.sin(u);s.push(c,d,v)}for(var a=1;a<=o;a++)for(var l=1;l<=i;l++){var f=(i+1)*a+l-1,y=(i+1)*(a-1)+l-1,m=(i+1)*(a-1)+l,w=(i+1)*a+l;r.push(f,y,w);r.push(y,m,w)}return new h(s,r)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(t,e,o){e.exports=r;var i=t("../math/Vec3"),n=t("../math/Quaternion"),s=t("./Solver");function r(){s.call(this);this.iterations=10;this.tolerance=1e-7}r.prototype=new s;var a=[],l=[],h=[];r.prototype.solve=function(t,e){var o=0,i=this.iterations,n=this.tolerance*this.tolerance,s=this.equations,r=s.length,p=e.bodies,u=p.length,c=t,d,v,f,y,m,w,x;if(0!==r)for(var g=0;g!==u;g++)p[g].updateSolveMassProperties();var b=l,B=h,E=a;b.length=r;B.length=r;E.length=r;for(var g=0;g!==r;g++){var A=s[g];E[g]=0;B[g]=A.computeB(c);b[g]=1/A.computeC()}if(0!==r){for(var g=0;g!==u;g++){var S,C=(S=p[g]).vlambda,z=S.wlambda;C.set(0,0,0);z&&z.set(0,0,0)}for(o=0;o!==i;o++){m=0;for(var q=0;q!==r;q++){var A=s[q];v=B[q];f=b[q];(x=E[q])+(y=f*(v-(w=A.computeGWlambda())-A.eps*x))<A.minForce?y=A.minForce-x:x+y>A.maxForce&&(y=A.maxForce-x);E[q]+=y;m+=y>0?y:-y;A.addToWlambda(y)}if(m*m<n)break}for(var g=0;g!==u;g++){var S,M=(S=p[g]).velocity,R=S.angularVelocity;M.vadd(S.vlambda,M);R&&R.vadd(S.wlambda,R)}}return o}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(t,e,o){e.exports=i;function i(){this.equations=[]}i.prototype.solve=function(t,e){return 0};i.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)};i.prototype.removeEquation=function(t){var e=this.equations,o=e.indexOf(t);-1!==o&&e.splice(o,1)};i.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(t,e,o){e.exports=a;var i=t("../math/Vec3"),n=t("../math/Quaternion"),s=t("./Solver"),r=t("../objects/Body");function a(t){s.call(this);this.iterations=10;this.tolerance=1e-7;this.subsolver=t;this.nodes=[];this.nodePool=[];for(;this.nodePool.length<128;)this.nodePool.push(this.createNode())}a.prototype=new s;var l=[],h=[],p=[],u=[],c={bodies:[]},d=r.STATIC;function v(t){for(var e=t.length,o=0;o!==e;o++){var i=t[o];if(!(i.visited||i.body.type&d))return i}return 0}var f=[];function y(t,e,o,i){f.push(t);t.visited=1;e(t,o,i);for(;f.length;)for(var n=f.pop(),s;s=v(n.children);){s.visited=1;e(s,o,i);f.push(s)}}function m(t,e,o){e.push(t.body);for(var i=t.eqs.length,n=0;n!==i;n++){var s=t.eqs[n];-1===o.indexOf(s)&&o.push(s)}}a.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:0}};a.prototype.solve=function(t,e){for(var o=l,i=this.nodePool,n=e.bodies,s=this.equations,r=s.length,a=n.length,h=this.subsolver;i.length<a;)i.push(this.createNode());o.length=a;for(var u=0;u<a;u++)o[u]=i[u];for(var u=0;u!==a;u++){var d=o[u];d.body=n[u];d.children.length=0;d.eqs.length=0;d.visited=0}for(var f=0;f!==r;f++){var x=s[f],u=n.indexOf(x.bi),g=n.indexOf(x.bj),b=o[u],B=o[g];b.children.push(B);b.eqs.push(x);B.children.push(b);B.eqs.push(x)}var E,A=0,S=p;h.tolerance=this.tolerance;h.iterations=this.iterations;for(var C=c;E=v(o);){S.length=0;C.bodies.length=0;y(E,m,C.bodies,S);var z=S.length;S=S.sort(w);for(var u=0;u!==z;u++)h.addEquation(S[u]);var q=h.solve(t,C);h.removeAllEquations();A++}return A};function w(t,e){return e.id-t.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(t,e,o){var i=function(){};e.exports=i;i.prototype={constructor:i,addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var o=this._listeners;void 0===o[t]&&(o[t]=[]);-1===o[t].indexOf(e)&&o[t].push(e);return this},hasEventListener:function(t,e){if(void 0===this._listeners)return 0;var o=this._listeners;return void 0!==o[t]&&-1!==o[t].indexOf(e)?1:0},removeEventListener:function(t,e){if(void 0===this._listeners)return this;var o=this._listeners;if(void 0===o[t])return this;var i=o[t].indexOf(e);-1!==i&&o[t].splice(i,1);return this},dispatchEvent:function(t){if(void 0===this._listeners)return this;var e,o=this._listeners[t.type];if(void 0!==o){t.target=this;for(var i=0,n=o.length;i<n;i++)o[i].call(this,t)}return this}}},{}],50:[function(t,e,o){var i=t("../collision/AABB"),n=t("../math/Vec3");e.exports=r;function s(t){t=t||{};this.root=t.root||null;this.aabb=t.aabb?t.aabb.clone():new i;this.data=[];this.children=[]}function r(t,e){(e=e||{}).root=null;e.aabb=t;s.call(this,e);this.maxDepth="undefined"!=typeof e.maxDepth?e.maxDepth:8}r.prototype=new s;s.prototype.reset=function(t,e){this.children.length=this.data.length=0};s.prototype.insert=function(t,e,o){var i=this.data;o=o||0;if(!this.aabb.contains(t))return 0;var n=this.children;if(o<(this.maxDepth||this.root.maxDepth)){var s=0;if(!n.length){this.subdivide();s=1}for(var r=0;8!==r;r++)if(n[r].insert(t,e,o+1))return 1;s&&(n.length=0)}i.push(e);return 1};var a=new n;s.prototype.subdivide=function(){var t=this.aabb,e=t.lowerBound,o=t.upperBound,r=this.children;r.push(new s({aabb:new i({lowerBound:new n(0,0,0)})}),new s({aabb:new i({lowerBound:new n(1,0,0)})}),new s({aabb:new i({lowerBound:new n(1,1,0)})}),new s({aabb:new i({lowerBound:new n(1,1,1)})}),new s({aabb:new i({lowerBound:new n(0,1,1)})}),new s({aabb:new i({lowerBound:new n(0,0,1)})}),new s({aabb:new i({lowerBound:new n(1,0,1)})}),new s({aabb:new i({lowerBound:new n(0,1,0)})}));o.vsub(e,a);a.scale(.5,a);for(var l=this.root||this,h=0;8!==h;h++){var p=r[h];p.root=l;var u=p.aabb.lowerBound;u.x*=a.x;u.y*=a.y;u.z*=a.z;u.vadd(e,u);u.vadd(a,p.aabb.upperBound)}};s.prototype.aabbQuery=function(t,e){for(var o=this.data,i=this.children,n=[this];n.length;){var s=n.pop();s.aabb.overlaps(t)&&Array.prototype.push.apply(e,s.data);Array.prototype.push.apply(n,s.children)}return e};var l=new i;s.prototype.rayQuery=function(t,e,o){t.getAABB(l);l.toLocalFrame(e,l);this.aabbQuery(l,o);return o};s.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var e=t.pop(),o=e.children.length-1;o>=0;o--)e.children[o].data.length||e.children.splice(o,1);Array.prototype.push.apply(t,e.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(t,e,o){e.exports=i;function i(){this.objects=[];this.type=Object}i.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e])};i.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()};i.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(t,e,o){e.exports=i;function i(){this.data={keys:[]}}i.prototype.get=function(t,e){if(t>e){var o=e;e=t;t=o}return this.data[t+"-"+e]};i.prototype.set=function(t,e,o){if(t>e){var i=e;e=t;t=i}var n=t+"-"+e;this.get(t,e)||this.data.keys.push(n);this.data[n]=o};i.prototype.reset=function(){for(var t=this.data,e=t.keys;e.length>0;){var o;delete t[e.pop()]}}},{}],53:[function(t,e,o){function i(){}e.exports=i;i.defaults=function(t,e){t=t||{};for(var o in e)o in t||(t[o]=e[o]);return t}},{}],54:[function(t,e,o){e.exports=s;var i=t("../math/Vec3"),n=t("./Pool");function s(){n.call(this);this.type=i}s.prototype=new n;s.prototype.constructObject=function(){return new i}},{"../math/Vec3":30,"./Pool":51}],55:[function(t,e,o){e.exports=v;var i=t("../collision/AABB"),n=t("../shapes/Shape"),s=t("../collision/Ray"),r=t("../math/Vec3"),a=t("../math/Transform"),l=t("../shapes/ConvexPolyhedron"),h=t("../math/Quaternion"),p=t("../solver/Solver"),u=t("../utils/Vec3Pool"),c=t("../equations/ContactEquation"),d=t("../equations/FrictionEquation");function v(t){this.contactPointPool=[];this.frictionEquationPool=[];this.result=[];this.frictionResult=[];this.v3pool=new u;this.world=t;this.currentContactMaterial=null;this.enableFrictionReduction=0}v.prototype.createContactEquation=function(t,e,o,i,n,s){var r;if(this.contactPointPool.length){(r=this.contactPointPool.pop()).bi=t;r.bj=e}else r=new c(t,e);r.enabled=t.collisionResponse&&e.collisionResponse&&o.collisionResponse&&i.collisionResponse;var a=this.currentContactMaterial;r.restitution=a.restitution;r.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt);var l=o.material||t.material,h=i.material||e.material;l&&h&&l.restitution>=0&&h.restitution>=0&&(r.restitution=l.restitution*h.restitution);r.si=n||o;r.sj=s||i;return r};v.prototype.createFrictionEquationsFromContact=function(t,e){var o=t.bi,i=t.bj,n=t.si,s=t.sj,r=this.world,a=this.currentContactMaterial,l=a.friction,h=n.material||o.material,p=s.material||i.material;h&&p&&h.friction>=0&&p.friction>=0&&(l=h.friction*p.friction);if(l>0){var u=l*r.gravity.length(),c=o.invMass+i.invMass;c>0&&(c=1/c);var v=this.frictionEquationPool,f=v.length?v.pop():new d(o,i,u*c),y=v.length?v.pop():new d(o,i,u*c);f.bi=y.bi=o;f.bj=y.bj=i;f.minForce=y.minForce=-u*c;f.maxForce=y.maxForce=u*c;f.ri.copy(t.ri);f.rj.copy(t.rj);y.ri.copy(t.ri);y.rj.copy(t.rj);t.ni.tangents(f.t,y.t);f.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt);y.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt);f.enabled=y.enabled=t.enabled;e.push(f,y);return 1}return 0};var f=new r,y=new r,m=new r;v.prototype.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var o=this.frictionResult[this.frictionResult.length-2],i=this.frictionResult[this.frictionResult.length-1];f.setZero();y.setZero();m.setZero();for(var n=e.bi,s=e.bj,r=0;r!==t;r++)if((e=this.result[this.result.length-1-r]).bodyA!==n){f.vadd(e.ni,f);y.vadd(e.ri,y);m.vadd(e.rj,m)}else{f.vsub(e.ni,f);y.vadd(e.rj,y);m.vadd(e.ri,m)}var a=1/t;y.scale(a,o.ri);m.scale(a,o.rj);i.ri.copy(o.ri);i.rj.copy(o.rj);f.normalize();f.tangents(o.t,i.t)}};var w=new r,x=new r,g=new h,b=new h;v.prototype.getContacts=function(t,e,o,i,n,s,r){this.contactPointPool=n;this.frictionEquationPool=r;this.result=i;this.frictionResult=s;for(var a=g,l=b,h=w,p=x,u=0,c=t.length;u!==c;u++){var d=t[u],v=e[u],f=null;d.material&&v.material&&(f=o.getContactMaterial(d.material,v.material)||null);for(var y=0;y<d.shapes.length;y++){d.quaternion.mult(d.shapeOrientations[y],a);d.quaternion.vmult(d.shapeOffsets[y],h);h.vadd(d.position,h);for(var m=d.shapes[y],B=0;B<v.shapes.length;B++){v.quaternion.mult(v.shapeOrientations[B],l);v.quaternion.vmult(v.shapeOffsets[B],p);p.vadd(v.position,p);var E=v.shapes[B];if(!(h.distanceTo(p)>m.boundingSphereRadius+E.boundingSphereRadius)){var A=null;m.material&&E.material&&(A=o.getContactMaterial(m.material,E.material)||null);this.currentContactMaterial=A||f||o.defaultContactMaterial;var S=this[m.type|E.type];S&&(m.type<E.type?S.call(this,m,E,h,p,a,l,d,v,m,E):S.call(this,E,m,p,h,l,a,v,d,m,E))}}}}};var B=0,E=10;function A(t){if(!(B>E)){B++;void 0}}v.prototype[n.types.BOX|n.types.BOX]=v.prototype.boxBox=function(t,e,o,i,n,s,r,a){t.convexPolyhedronRepresentation.material=t.material;e.convexPolyhedronRepresentation.material=e.material;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,o,i,n,s,r,a,t,e)};v.prototype[n.types.BOX|n.types.CONVEXPOLYHEDRON]=v.prototype.boxConvex=function(t,e,o,i,n,s,r,a){t.convexPolyhedronRepresentation.material=t.material;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;this.convexConvex(t.convexPolyhedronRepresentation,e,o,i,n,s,r,a,t,e)};v.prototype[n.types.BOX|n.types.PARTICLE]=v.prototype.boxParticle=function(t,e,o,i,n,s,r,a){t.convexPolyhedronRepresentation.material=t.material;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;this.convexParticle(t.convexPolyhedronRepresentation,e,o,i,n,s,r,a,t,e)};v.prototype[n.types.SPHERE]=v.prototype.sphereSphere=function(t,e,o,i,n,s,r,a){var l=this.createContactEquation(r,a,t,e);i.vsub(o,l.ni);l.ni.normalize();l.ri.copy(l.ni);l.rj.copy(l.ni);l.ri.mult(t.radius,l.ri);l.rj.mult(-e.radius,l.rj);l.ri.vadd(o,l.ri);l.ri.vsub(r.position,l.ri);l.rj.vadd(i,l.rj);l.rj.vsub(a.position,l.rj);this.result.push(l);this.createFrictionEquationsFromContact(l,this.frictionResult)};var S=new r,C=new r,z=new r;v.prototype[n.types.PLANE|n.types.TRIMESH]=v.prototype.planeTrimesh=function(t,e,o,i,n,s,l,h){var p=new r,u=S;u.set(0,0,1);n.vmult(u,u);for(var c=0;c<e.vertices.length/3;c++){e.getVertex(c,p);var d=new r;d.copy(p);a.pointToWorldFrame(i,s,d,p);var v=C,f;p.vsub(o,v);if(u.dot(v)<=0){var y=this.createContactEquation(l,h,t,e);y.ni.copy(u);var m=z;u.scale(v.dot(u),m);p.vsub(m,m);y.ri.copy(m);y.ri.vsub(l.position,y.ri);y.rj.copy(p);y.rj.vsub(h.position,y.rj);this.result.push(y);this.createFrictionEquationsFromContact(y,this.frictionResult)}}};var q=new r,M=new r,R=new r,P=new r,F=new r,V=new r,T=new r,I=new r,N=new r,W=new r,L=new r,j=new r,O=new r,_=new r,k=new i,U=[];v.prototype[n.types.SPHERE|n.types.TRIMESH]=v.prototype.sphereTrimesh=function(t,e,o,i,n,r,l,h){var p=V,u=T,c=I,d=N,v=W,f=L,y=k,m=F,w=M,x=U;a.pointToLocalFrame(i,r,o,v);var g=t.radius;y.lowerBound.set(v.x-g,v.y-g,v.z-g);y.upperBound.set(v.x+g,v.y+g,v.z+g);e.getTrianglesInAABB(y,x);for(var b=P,B=t.radius*t.radius,E=0;E<x.length;E++)for(var A=0;A<3;A++){e.getVertex(e.indices[3*x[E]+A],b);b.vsub(v,w);if(w.norm2()<=B){m.copy(b);a.pointToWorldFrame(i,r,m,b);b.vsub(o,w);var S;(S=this.createContactEquation(l,h,t,e)).ni.copy(w);S.ni.normalize();S.ri.copy(S.ni);S.ri.scale(t.radius,S.ri);S.ri.vadd(o,S.ri);S.ri.vsub(l.position,S.ri);S.rj.copy(b);S.rj.vsub(h.position,S.rj);this.result.push(S);this.createFrictionEquationsFromContact(S,this.frictionResult)}}for(var E=0;E<x.length;E++)for(var A=0;A<3;A++){e.getVertex(e.indices[3*x[E]+A],p);e.getVertex(e.indices[3*x[E]+(A+1)%3],u);u.vsub(p,c);v.vsub(u,f);var C=f.dot(c);v.vsub(p,f);var z=f.dot(c);if(z>0&&C<0){v.vsub(p,f);d.copy(c);d.normalize();z=f.dot(d);d.scale(z,f);f.vadd(p,f);var R;if((R=f.distanceTo(v))<t.radius){var S=this.createContactEquation(l,h,t,e);f.vsub(v,S.ni);S.ni.normalize();S.ni.scale(t.radius,S.ri);a.pointToWorldFrame(i,r,f,f);f.vsub(h.position,S.rj);a.vectorToWorldFrame(r,S.ni,S.ni);a.vectorToWorldFrame(r,S.ri,S.ri);this.result.push(S);this.createFrictionEquationsFromContact(S,this.frictionResult)}}}for(var H=j,D=O,X=_,G=q,E=0,Y=x.length;E!==Y;E++){e.getTriangleVertices(x[E],H,D,X);e.getNormal(x[E],G);v.vsub(H,f);var R=f.dot(G);G.scale(R,f);v.vsub(f,f);R=f.distanceTo(v);if(s.pointInTriangle(f,H,D,X)&&R<t.radius){var S=this.createContactEquation(l,h,t,e);f.vsub(v,S.ni);S.ni.normalize();S.ni.scale(t.radius,S.ri);a.pointToWorldFrame(i,r,f,f);f.vsub(h.position,S.rj);a.vectorToWorldFrame(r,S.ni,S.ni);a.vectorToWorldFrame(r,S.ri,S.ri);this.result.push(S);this.createFrictionEquationsFromContact(S,this.frictionResult)}}x.length=0};var H=new r,D=new r;v.prototype[n.types.SPHERE|n.types.PLANE]=v.prototype.spherePlane=function(t,e,o,i,n,s,r,a){var l=this.createContactEquation(r,a,t,e);l.ni.set(0,0,1);s.vmult(l.ni,l.ni);l.ni.negate(l.ni);l.ni.normalize();l.ni.mult(t.radius,l.ri);o.vsub(i,H);l.ni.mult(l.ni.dot(H),D);H.vsub(D,l.rj);if(-H.dot(l.ni)<=t.radius){var h=l.ri,p=l.rj;h.vadd(o,h);h.vsub(r.position,h);p.vadd(i,p);p.vsub(a.position,p);this.result.push(l);this.createFrictionEquationsFromContact(l,this.frictionResult)}};var X=new r,G=new r,Y=new r;function Q(t,e,o){for(var i=null,n=t.length,s=0;s!==n;s++){var r=t[s],a=X;t[(s+1)%n].vsub(r,a);var l=G;a.cross(e,l);var h=Y;o.vsub(r,h);var p=l.dot(h);if(!(null===i||p>0&&1==i||p<=0&&0==i))return 0;null===i&&(i=p>0)}return 1}var Z=new r,K=new r,J=new r,$=new r,tt=[new r,new r,new r,new r,new r,new r],et=new r,ot=new r,it=new r,nt=new r;v.prototype[n.types.SPHERE|n.types.BOX]=v.prototype.sphereBox=function(t,e,o,i,n,s,r,a){var l=this.v3pool,h=tt;o.vsub(i,Z);e.getSideNormals(h,s);for(var p=t.radius,u=[],c=0,d=ot,v=it,f=nt,y=null,m=0,w=0,x=0,g=null,b=0,B=h.length;b!==B&&0==c;b++){var E=K;E.copy(h[b]);var A=E.norm();E.normalize();var S=Z.dot(E);if(S<A+p&&S>0){var C=J,z=$;C.copy(h[(b+1)%3]);z.copy(h[(b+2)%3]);var q=C.norm(),M=z.norm();C.normalize();z.normalize();var R=Z.dot(C),P=Z.dot(z);if(R<q&&R>-q&&P<M&&P>-M){var F=Math.abs(S-A-p);if(null===g||F<g){g=F;w=R;x=P;y=A;d.copy(E);v.copy(C);f.copy(z);m++}}}}if(m){c=1;var V=this.createContactEquation(r,a,t,e);d.mult(-p,V.ri);V.ni.copy(d);V.ni.negate(V.ni);d.mult(y,d);v.mult(w,v);d.vadd(v,d);f.mult(x,f);d.vadd(f,V.rj);V.ri.vadd(o,V.ri);V.ri.vsub(r.position,V.ri);V.rj.vadd(i,V.rj);V.rj.vsub(a.position,V.rj);this.result.push(V);this.createFrictionEquationsFromContact(V,this.frictionResult)}for(var T=l.get(),I=et,N=0;2!==N&&!c;N++)for(var W=0;2!==W&&!c;W++)for(var L=0;2!==L&&!c;L++){T.set(0,0,0);N?T.vadd(h[0],T):T.vsub(h[0],T);W?T.vadd(h[1],T):T.vsub(h[1],T);L?T.vadd(h[2],T):T.vsub(h[2],T);i.vadd(T,I);I.vsub(o,I);if(I.norm2()<p*p){c=1;var V;(V=this.createContactEquation(r,a,t,e)).ri.copy(I);V.ri.normalize();V.ni.copy(V.ri);V.ri.mult(p,V.ri);V.rj.copy(T);V.ri.vadd(o,V.ri);V.ri.vsub(r.position,V.ri);V.rj.vadd(i,V.rj);V.rj.vsub(a.position,V.rj);this.result.push(V);this.createFrictionEquationsFromContact(V,this.frictionResult)}}l.release(T);T=null;for(var j=l.get(),O=l.get(),V=l.get(),_=l.get(),F=l.get(),k=h.length,N=0;N!==k&&!c;N++)for(var W=0;W!==k&&!c;W++)if(N%3!=W%3){h[W].cross(h[N],j);j.normalize();h[N].vadd(h[W],O);V.copy(o);V.vsub(O,V);V.vsub(i,V);var U=V.dot(j);j.mult(U,_);for(var L=0;L===N%3||L===W%3;)L++;F.copy(o);F.vsub(_,F);F.vsub(O,F);F.vsub(i,F);var H=Math.abs(U),D=F.norm();if(H<h[L].norm()&&D<p){c=1;var X=this.createContactEquation(r,a,t,e);O.vadd(_,X.rj);X.rj.copy(X.rj);F.negate(X.ni);X.ni.normalize();X.ri.copy(X.rj);X.ri.vadd(i,X.ri);X.ri.vsub(o,X.ri);X.ri.normalize();X.ri.mult(p,X.ri);X.ri.vadd(o,X.ri);X.ri.vsub(r.position,X.ri);X.rj.vadd(i,X.rj);X.rj.vsub(a.position,X.rj);this.result.push(X);this.createFrictionEquationsFromContact(X,this.frictionResult)}}l.release(j,O,V,_,F)};var st=new r,rt=new r,at=new r,lt=new r,ht=new r,pt=new r,ut=new r,ct=new r,dt=new r,vt=new r;v.prototype[n.types.SPHERE|n.types.CONVEXPOLYHEDRON]=v.prototype.sphereConvex=function(t,e,o,i,n,s,r,a){var l=this.v3pool;o.vsub(i,st);for(var h=e.faceNormals,p=e.faces,u=e.vertices,c=t.radius,d=[],v=0;v!==u.length;v++){var f=u[v],y=ht;s.vmult(f,y);i.vadd(y,y);var m=lt;y.vsub(o,m);if(m.norm2()<c*c){x=1;var w;(w=this.createContactEquation(r,a,t,e)).ri.copy(m);w.ri.normalize();w.ni.copy(w.ri);w.ri.mult(c,w.ri);y.vsub(i,w.rj);w.ri.vadd(o,w.ri);w.ri.vsub(r.position,w.ri);w.rj.vadd(i,w.rj);w.rj.vsub(a.position,w.rj);this.result.push(w);this.createFrictionEquationsFromContact(w,this.frictionResult);return}}for(var x=0,v=0,g=p.length;v!==g&&0==x;v++){var b=h[v],B=p[v],E=pt;s.vmult(b,E);var A=ut;s.vmult(u[B[0]],A);A.vadd(i,A);var S=ct;E.mult(-c,S);o.vadd(S,S);var C=dt;S.vsub(A,C);var z=C.dot(E),q=vt;o.vsub(A,q);if(z<0&&q.dot(E)>0){for(var M=[],R=0,P=B.length;R!==P;R++){var F=l.get();s.vmult(u[B[R]],F);i.vadd(F,F);M.push(F)}if(Q(M,E,o)){x=1;var w=this.createContactEquation(r,a,t,e);E.mult(-c,w.ri);E.negate(w.ni);var V=l.get();E.mult(-z,V);var T=l.get();E.mult(-c,T);o.vsub(i,w.rj);w.rj.vadd(T,w.rj);w.rj.vadd(V,w.rj);w.rj.vadd(i,w.rj);w.rj.vsub(a.position,w.rj);w.ri.vadd(o,w.ri);w.ri.vsub(r.position,w.ri);l.release(V);l.release(T);this.result.push(w);this.createFrictionEquationsFromContact(w,this.frictionResult);for(var R=0,I=M.length;R!==I;R++)l.release(M[R]);return}for(var R=0;R!==B.length;R++){var N=l.get(),W=l.get();s.vmult(u[B[(R+1)%B.length]],N);s.vmult(u[B[(R+2)%B.length]],W);i.vadd(N,N);i.vadd(W,W);var L=rt;W.vsub(N,L);var j=at;L.unit(j);var O=l.get(),_=l.get();o.vsub(N,_);var k=_.dot(j);j.mult(k,O);O.vadd(N,O);var U=l.get();O.vsub(o,U);if(k>0&&k*k<L.norm2()&&U.norm2()<c*c){var w=this.createContactEquation(r,a,t,e);O.vsub(i,w.rj);O.vsub(o,w.ni);w.ni.normalize();w.ni.mult(c,w.ri);w.rj.vadd(i,w.rj);w.rj.vsub(a.position,w.rj);w.ri.vadd(o,w.ri);w.ri.vsub(r.position,w.ri);this.result.push(w);this.createFrictionEquationsFromContact(w,this.frictionResult);for(var R=0,I=M.length;R!==I;R++)l.release(M[R]);l.release(N);l.release(W);l.release(O);l.release(U);l.release(_);return}l.release(N);l.release(W);l.release(O);l.release(U);l.release(_)}for(var R=0,I=M.length;R!==I;R++)l.release(M[R])}}};var ft=new r,yt=new r;v.prototype[n.types.PLANE|n.types.BOX]=v.prototype.planeBox=function(t,e,o,i,n,s,r,a){e.convexPolyhedronRepresentation.material=e.material;e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse;this.planeConvex(t,e.convexPolyhedronRepresentation,o,i,n,s,r,a)};var mt=new r,wt=new r,xt=new r,gt=new r;v.prototype[n.types.PLANE|n.types.CONVEXPOLYHEDRON]=v.prototype.planeConvex=function(t,e,o,i,n,s,r,a){var l=mt,h=wt;h.set(0,0,1);n.vmult(h,h);for(var p=0,u=xt,c=0;c!==e.vertices.length;c++){l.copy(e.vertices[c]);s.vmult(l,l);i.vadd(l,l);l.vsub(o,u);var d;if(h.dot(u)<=0){var v=this.createContactEquation(r,a,t,e),f=gt;h.mult(h.dot(u),f);l.vsub(f,f);f.vsub(o,v.ri);v.ni.copy(h);l.vsub(i,v.rj);v.ri.vadd(o,v.ri);v.ri.vsub(r.position,v.ri);v.rj.vadd(i,v.rj);v.rj.vsub(a.position,v.rj);this.result.push(v);p++;this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)};var bt=new r,Bt=new r;v.prototype[n.types.CONVEXPOLYHEDRON]=v.prototype.convexConvex=function(t,e,o,i,n,s,r,a,l,h,p,u){var c=bt;if(!(o.distanceTo(i)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,o,n,i,s,c,p,u)){var d=[],v=Bt;t.clipAgainstHull(o,n,e,i,s,c,-100,100,d);for(var f=0,y=0;y!==d.length;y++){var m=this.createContactEquation(r,a,t,e,l,h),w=m.ri,x=m.rj;c.negate(m.ni);d[y].normal.negate(v);v.mult(d[y].depth,v);d[y].point.vadd(v,w);x.copy(d[y].point);w.vsub(o,w);x.vsub(i,x);w.vadd(o,w);w.vsub(r.position,w);x.vadd(i,x);x.vsub(a.position,x);this.result.push(m);f++;this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)}};var Et=new r,At=new r,St=new r;v.prototype[n.types.PLANE|n.types.PARTICLE]=v.prototype.planeParticle=function(t,e,o,i,n,s,r,a){var l=Et;l.set(0,0,1);r.quaternion.vmult(l,l);var h=At,p;i.vsub(r.position,h);if(l.dot(h)<=0){var u=this.createContactEquation(a,r,e,t);u.ni.copy(l);u.ni.negate(u.ni);u.ri.set(0,0,0);var c=St;l.mult(l.dot(i),c);i.vsub(c,c);u.rj.copy(c);this.result.push(u);this.createFrictionEquationsFromContact(u,this.frictionResult)}};var Ct=new r;v.prototype[n.types.PARTICLE|n.types.SPHERE]=v.prototype.sphereParticle=function(t,e,o,i,n,s,r,a){var l=Ct,h;l.set(0,0,1);i.vsub(o,l);if(l.norm2()<=t.radius*t.radius){var p=this.createContactEquation(a,r,e,t);l.normalize();p.rj.copy(l);p.rj.mult(t.radius,p.rj);p.ni.copy(l);p.ni.negate(p.ni);p.ri.set(0,0,0);this.result.push(p);this.createFrictionEquationsFromContact(p,this.frictionResult)}};var zt=new h,qt=new r,Mt=new r,Rt=new r,Pt=new r,Ft=new r;v.prototype[n.types.PARTICLE|n.types.CONVEXPOLYHEDRON]=v.prototype.convexParticle=function(t,e,o,i,n,s,r,a){var l=-1,h=Rt,p=Ft,u=null,c=0,d=qt;d.copy(i);d.vsub(o,d);n.conjugate(zt);zt.vmult(d,d);if(t.pointIsInside(d)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(o,n);t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(n);for(var v=0,f=t.faces.length;v!==f;v++){var y=[t.worldVertices[t.faces[v][0]]],m=t.worldFaceNormals[v];i.vsub(y[0],Pt);var w=-m.dot(Pt);if(null===u||Math.abs(w)<Math.abs(u)){u=w;l=v;h.copy(m);c++}}if(-1!==l){var x=this.createContactEquation(a,r,e,t);h.mult(u,p);p.vadd(i,p);p.vsub(o,p);x.rj.copy(p);h.negate(x.ni);x.ri.set(0,0,0);var g=x.ri,b=x.rj;g.vadd(i,g);g.vsub(a.position,g);b.vadd(o,b);b.vsub(r.position,b);this.result.push(x);this.createFrictionEquationsFromContact(x,this.frictionResult)}else void 0}};v.prototype[n.types.BOX|n.types.HEIGHTFIELD]=v.prototype.boxHeightfield=function(t,e,o,i,n,s,r,a){t.convexPolyhedronRepresentation.material=t.material;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;this.convexHeightfield(t.convexPolyhedronRepresentation,e,o,i,n,s,r,a)};var Vt=new r,Tt=new r,It=[0];v.prototype[n.types.CONVEXPOLYHEDRON|n.types.HEIGHTFIELD]=v.prototype.convexHeightfield=function(t,e,o,i,n,s,r,l){var h=e.data,p=e.elementSize,u=t.boundingSphereRadius,c=Tt,d=It,v=Vt;a.pointToLocalFrame(i,s,o,v);var f=Math.floor((v.x-u)/p)-1,y=Math.ceil((v.x+u)/p)+1,m=Math.floor((v.y-u)/p)-1,w=Math.ceil((v.y+u)/p)+1;if(!(y<0||w<0||f>h.length||m>h[0].length)){f<0&&(f=0);y<0&&(y=0);m<0&&(m=0);w<0&&(w=0);f>=h.length&&(f=h.length-1);y>=h.length&&(y=h.length-1);w>=h[0].length&&(w=h[0].length-1);m>=h[0].length&&(m=h[0].length-1);var x=[];e.getRectMinMax(f,m,y,w,x);var g=x[0],b=x[1];if(!(v.z-u>b||v.z+u<g))for(var B=f;B<y;B++)for(var E=m;E<w;E++){e.getConvexTrianglePillar(B,E,0);a.pointToWorldFrame(i,s,e.pillarOffset,c);o.distanceTo(c)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,o,c,n,s,r,l,null,null,d,null);e.getConvexTrianglePillar(B,E,1);a.pointToWorldFrame(i,s,e.pillarOffset,c);o.distanceTo(c)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,o,c,n,s,r,l,null,null,d,null)}}};var Nt=new r,Wt=new r;v.prototype[n.types.SPHERE|n.types.HEIGHTFIELD]=v.prototype.sphereHeightfield=function(t,e,o,i,n,s,r,l){var h=e.data,p=t.radius,u=e.elementSize,c=Wt,d=Nt;a.pointToLocalFrame(i,s,o,d);var v=Math.floor((d.x-p)/u)-1,f=Math.ceil((d.x+p)/u)+1,y=Math.floor((d.y-p)/u)-1,m=Math.ceil((d.y+p)/u)+1;if(!(f<0||m<0||v>h.length||m>h[0].length)){v<0&&(v=0);f<0&&(f=0);y<0&&(y=0);m<0&&(m=0);v>=h.length&&(v=h.length-1);f>=h.length&&(f=h.length-1);m>=h[0].length&&(m=h[0].length-1);y>=h[0].length&&(y=h[0].length-1);var w=[];e.getRectMinMax(v,y,f,m,w);var x=w[0],g=w[1];if(!(d.z-p>g||d.z+p<x))for(var b=this.result,B=v;B<f;B++)for(var E=y;E<m;E++){var A=b.length,S;e.getConvexTrianglePillar(B,E,0);a.pointToWorldFrame(i,s,e.pillarOffset,c);o.distanceTo(c)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,o,c,n,s,r,l);e.getConvexTrianglePillar(B,E,1);a.pointToWorldFrame(i,s,e.pillarOffset,c);o.distanceTo(c)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,o,c,n,s,r,l);if(b.length-A>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(t,e,o){e.exports=b;var i=t("../shapes/Shape"),n=t("../math/Vec3"),s=t("../math/Quaternion"),r=t("../solver/GSSolver"),a=t("../utils/Vec3Pool"),l=t("../equations/ContactEquation"),h=t("../equations/FrictionEquation"),p=t("./Narrowphase"),u=t("../utils/EventTarget"),c=t("../collision/ArrayCollisionMatrix"),d=t("../material/Material"),v=t("../material/ContactMaterial"),f=t("../objects/Body"),y=t("../utils/TupleDictionary"),m=t("../collision/RaycastResult"),w=t("../collision/AABB"),x=t("../collision/Ray"),g=t("../collision/NaiveBroadphase");function b(){u.apply(this);this.dt=-1;this.allowSleep=0;this.contacts=[];this.frictionEquations=[];this.quatNormalizeSkip=0;this.quatNormalizeFast=0;this.time=0;this.stepnumber=0;this.default_dt=1/60;this.nextId=0;this.gravity=new n;this.broadphase=new g;this.bodies=[];this.solver=new r;this.constraints=[];this.narrowphase=new p(this);this.collisionMatrix=new c;this.collisionMatrixPrevious=new c;this.materials=[];this.contactmaterials=[];this.contactMaterialTable=new y;this.defaultMaterial=new d("default");this.defaultContactMaterial=new v(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0});this.doProfiling=0;this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0};this.subsystems=[];this.addBodyEvent={type:"addBody",body:null};this.removeBodyEvent={type:"removeBody",body:null}}b.prototype=new u;var B=new w,E=[],A=new x;b.prototype.getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)};b.prototype.numObjects=function(){return this.bodies.length};b.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix;this.collisionMatrix=t;this.collisionMatrix.reset()};b.prototype.add=b.prototype.addBody=function(t){if(-1===this.bodies.indexOf(t)){t.index=this.bodies.length;this.bodies.push(t);t.world=this;t.initPosition.copy(t.position);t.initVelocity.copy(t.velocity);t.timeLastSleepy=this.time;if(t instanceof f){t.initAngularVelocity.copy(t.angularVelocity);t.initQuaternion.copy(t.quaternion)}this.collisionMatrix.setNumObjects(this.bodies.length);this.addBodyEvent.body=t;this.dispatchEvent(this.addBodyEvent)}};b.prototype.addConstraint=function(t){this.constraints.push(t)};b.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)};b.prototype.rayTest=function(t,e,o){o instanceof m?this.raycastClosest(t,e,{skipBackfaces:1},o):this.raycastAll(t,e,{skipBackfaces:1},o)};b.prototype.raycastAll=function(t,e,o,i){o.mode=x.ALL;o.from=t;o.to=e;o.callback=i;return A.intersectWorld(this,o)};b.prototype.raycastAny=function(t,e,o,i){o.mode=x.ANY;o.from=t;o.to=e;o.result=i;return A.intersectWorld(this,o)};b.prototype.raycastClosest=function(t,e,o,i){o.mode=x.CLOSEST;o.from=t;o.to=e;o.result=i;return A.intersectWorld(this,o)};b.prototype.remove=function(t){t.world=null;var e=this.bodies.length-1,o=this.bodies,i=o.indexOf(t);if(-1!==i){o.splice(i,1);for(var n=0;n!==o.length;n++)o[n].index=n;this.collisionMatrix.setNumObjects(e);this.removeBodyEvent.body=t;this.dispatchEvent(this.removeBodyEvent)}};b.prototype.removeBody=b.prototype.remove;b.prototype.addMaterial=function(t){this.materials.push(t)};b.prototype.addContactMaterial=function(t){this.contactmaterials.push(t);this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)};"undefined"==typeof performance&&(performance={});if(!performance.now){var S=Date.now();performance.timing&&performance.timing.navigationStart&&(S=performance.timing.navigationStart);performance.now=function(){return Date.now()-S}}var C=new n;b.prototype.step=function(t,e,o){o=o||10;if(0===(e=e||0)){this.internalStep(t);this.time+=t}else{var i=Math.floor((this.time+e)/t)-Math.floor(this.time/t);i=Math.min(i,o);for(var n=performance.now(),s=0;s!==i;s++){this.internalStep(t);if(performance.now()-n>1e3*t)break}this.time+=e;for(var r,a=this.time%t/t,l=C,h=this.bodies,p=0;p!==h.length;p++){var u=h[p];if(u.type!==f.STATIC&&u.sleepState!==f.SLEEPING){u.position.vsub(u.previousPosition,l);l.scale(a,l);u.position.vadd(l,u.interpolatedPosition)}else{u.interpolatedPosition.copy(u.position);u.interpolatedQuaternion.copy(u.quaternion)}}}};var z={type:"postStep"},q={type:"preStep"},M={type:"collide",body:null,contact:null},R=[],P=[],F=[],V=[],T=new n,I=new n,N=new n,W=new n,L=new n,j=new n,O=new n,_=new n,k=new n,U=new s,H=new s,D=new s,X=new n;b.prototype.internalStep=function(t){this.dt=t;var e=this,o=this,n=this.contacts,s=F,r=V,a=this.numObjects(),l=this.bodies,h=this.solver,p=this.gravity,u=this.doProfiling,c=this.profile,d=f.DYNAMIC,v,y=this.constraints,m=P,w=p.norm(),x=p.x,g=p.y,b=p.z,B=0;u&&(v=performance.now());for(B=0;B!==a;B++){var E;if((E=l[B]).type&d){var A=E.force,S=E.mass;A.x+=S*x;A.y+=S*g;A.z+=S*b}}for(var B=0,C=this.subsystems.length;B!==C;B++)this.subsystems[B].update();u&&(v=performance.now());s.length=0;r.length=0;this.broadphase.collisionPairs(this,s,r);u&&(c.broadphase=performance.now()-v);var T=y.length;for(B=0;B!==T;B++){var I;if(!(I=y[B]).collideConnected)for(var N=s.length-1;N>=0;N-=1)if(I.bodyA===s[N]&&I.bodyB===r[N]||I.bodyB===s[N]&&I.bodyA===r[N]){s.splice(N,1);r.splice(N,1)}}this.collisionMatrixTick();u&&(v=performance.now());var W=R,L=n.length;for(B=0;B!==L;B++)W.push(n[B]);n.length=0;var j=this.frictionEquations.length;for(B=0;B!==j;B++)m.push(this.frictionEquations[B]);this.frictionEquations.length=0;this.narrowphase.getContacts(s,r,this,n,W,this.frictionEquations,m);u&&(c.narrowphase=performance.now()-v);u&&(v=performance.now());for(var B=0;B<this.frictionEquations.length;B++)h.addEquation(this.frictionEquations[B]);for(var O=n.length,_=0;_!==O;_++){var I,E=(I=n[_]).bi,k=I.bj,G=I.si,Y=I.sj,Q,Z=(Q=E.material&&k.material&&this.getContactMaterial(E.material,k.material)||this.defaultContactMaterial).friction;if(E.material&&k.material){E.material.friction>=0&&k.material.friction>=0&&(Z=E.material.friction*k.material.friction);E.material.restitution>=0&&k.material.restitution>=0&&(I.restitution=E.material.restitution*k.material.restitution)}h.addEquation(I);if(E.allowSleep&&E.type===f.DYNAMIC&&E.sleepState===f.SLEEPING&&k.sleepState===f.AWAKE&&k.type!==f.STATIC){var K,J;k.velocity.norm2()+k.angularVelocity.norm2()>=2*Math.pow(k.sleepSpeedLimit,2)&&(E._wakeUpAfterNarrowphase=1)}if(k.allowSleep&&k.type===f.DYNAMIC&&k.sleepState===f.SLEEPING&&E.sleepState===f.AWAKE&&E.type!==f.STATIC){var $,tt;E.velocity.norm2()+E.angularVelocity.norm2()>=2*Math.pow(E.sleepSpeedLimit,2)&&(k._wakeUpAfterNarrowphase=1)}this.collisionMatrix.set(E,k,1);if(!this.collisionMatrixPrevious.get(E,k)){M.body=k;M.contact=I;E.dispatchEvent(M);M.body=E;k.dispatchEvent(M)}}if(u){c.makeContactConstraints=performance.now()-v;v=performance.now()}for(B=0;B!==a;B++){var E;if((E=l[B])._wakeUpAfterNarrowphase){E.wakeUp();E._wakeUpAfterNarrowphase=0}}var T=y.length;for(B=0;B!==T;B++){var I;(I=y[B]).update();for(var N=0,et=I.equations.length;N!==et;N++){var ot=I.equations[N];h.addEquation(ot)}}h.solve(t,this);u&&(c.solve=performance.now()-v);h.removeAllEquations();var it=Math.pow;for(B=0;B!==a;B++){var E;if((E=l[B]).type&d){var nt=it(1-E.linearDamping,t),st=E.velocity;st.mult(nt,st);var rt=E.angularVelocity;if(rt){var at=it(1-E.angularDamping,t);rt.mult(at,rt)}}}this.dispatchEvent(q);for(B=0;B!==a;B++){var E;(E=l[B]).preStep&&E.preStep.call(E)}u&&(v=performance.now());var lt=U,ht=H,pt=D,ut=this.stepnumber,ct=f.DYNAMIC|f.KINEMATIC,dt=ut%(this.quatNormalizeSkip+1)==0,vt=this.quatNormalizeFast,ft=.5*t,yt=i.types.PLANE,mt=i.types.CONVEXPOLYHEDRON;for(B=0;B!==a;B++){var wt=l[B],xt=wt.force,gt=wt.torque;if(wt.type&ct&&wt.sleepState!==f.SLEEPING){var bt=wt.velocity,Bt=wt.angularVelocity,Et=wt.position,At=wt.quaternion,St=wt.invMass,Ct=wt.invInertiaWorld;bt.x+=xt.x*St*t;bt.y+=xt.y*St*t;bt.z+=xt.z*St*t;if(wt.angularVelocity){Ct.vmult(gt,X);X.mult(t,X);X.vadd(Bt,Bt)}Et.x+=bt.x*t;Et.y+=bt.y*t;Et.z+=bt.z*t;if(wt.angularVelocity){ht.set(Bt.x,Bt.y,Bt.z,0);ht.mult(At,pt);At.x+=ft*pt.x;At.y+=ft*pt.y;At.z+=ft*pt.z;At.w+=ft*pt.w;dt&&(vt?At.normalizeFast():At.normalize())}wt.aabb&&(wt.aabbNeedsUpdate=1);wt.updateInertiaWorld&&wt.updateInertiaWorld()}}this.clearForces();this.broadphase.dirty=1;u&&(c.integrate=performance.now()-v);this.time+=t;this.stepnumber+=1;this.dispatchEvent(z);for(B=0;B!==a;B++){var E,zt=(E=l[B]).postStep;zt&&zt.call(E)}if(this.allowSleep)for(B=0;B!==a;B++)l[B].sleepTick(this.time)};b.prototype.clearForces=function(){for(var t=this.bodies,e=t.length,o=0;o!==e;o++){var i=t[o],n=i.force,s=i.torque;i.force.set(0,0,0);i.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)}))}]));