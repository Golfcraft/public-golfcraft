var path = require('path');
var webpack = require('webpack');
const TerserPlugin = require('terser-webpack-plugin');
const exec = require('child_process').exec;
const fs = require('fs');
if(!process.env.WEBPACK_PLAYFAB_API_KEY){
    throw Error("Missing process.env.WEBPACK_PLAYFAB_API_KEY")
}

module.exports = () => {
    return {
        mode:'production',
        entry:'./cloudscript/main.ts',
        output:{
            path: path.resolve(__dirname, '..'),
            filename: '_cloudscript.js'
        },
        resolve: {
            // Add `.ts` and `.tsx` as a resolvable extension.
            extensions: [".ts", ".js"],      
        },
        module: {
            rules: [
              {
                test: /\.(t|j)sx?$/, 
                use: [
                 
                  {
                    loader: "ts-loader", 
                    options: {
                      transpileOnly: true,   
                      configFile:path.resolve(__dirname, '..','cloudscript','tsconfig.json')
                    } 
                  }   
                ]
              }
            ]
        },
        optimization: {
            minimize: true,
            minimizer:[
              new TerserPlugin({
                test: /\.(t|j)s$/i,               
              }),
            ]
        },
        plugins:[
            new webpack.BannerPlugin({banner:`/** NOT MODIFY THIS FILE: AUTOGENERATED **/`, raw:true, entryOnly:true}),
            new webpack.DefinePlugin({
                '_PLAYFAB_API_KEY_': JSON.stringify(process.env.WEBPACK_PLAYFAB_API_KEY),
            })
        ]
    }
}